<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>账单管理（稳定可用版）</title>
    <style>
        /* 极简稳定样式，确保按钮点击无冲突 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            background-color: #f5f5f7;
            color: #1c1c1e;
            padding: 20px;
            padding-bottom: 100px;
        }

        /* 导航栏 */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e5e7;
        }

        .navbar h1 {
            font-size: 20px;
            font-weight: 600;
        }

        /* 通用按钮样式 */
        button {
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background-color: #007aff;
            color: white;
            padding: 10px 16px;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #0066cc;
        }

        button.btn-cancel {
            background-color: #e5e5e7;
            color: #1c1c1e;
        }

        button.btn-cancel:hover {
            background-color: #d1d1d6;
        }

        button.btn-small {
            padding: 6px 10px;
            font-size: 12px;
            margin-left: 5px;
        }

        /* 卡片样式 */
        .card {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 统计卡片 */
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-item .label {
            font-size: 12px;
            color: #8e8e93;
            margin-bottom: 5px;
        }

        .stat-item .value {
            font-size: 18px;
            font-weight: 600;
        }

        /* 列表样式 */
        .list {
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .list.hidden {
            display: none;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e5e5e7;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item .info {
            flex: 1;
        }

        .list-item .name {
            font-weight: 500;
            margin-bottom: 3px;
        }

        .list-item .desc {
            font-size: 12px;
            color: #8e8e93;
            line-height: 1.4;
            word-break: break-word;
        }

        .list-item .actions {
            display: flex;
            gap: 5px;
        }

        /* 预算进度条 */
        .progress-container {
            width: 100%;
            height: 8px;
            background-color: #e5e5e7;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: #34c759;
            border-radius: 4px;
        }

        .progress-bar.over {
            background-color: #ff3b30;
        }

        /* 模态框 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
        }

        .modal-content h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e5e7;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            font-size: 14px;
            /* 确保所有输入框样式一致 */
            appearance: none;
            -webkit-appearance: none;
            background-color: white;
        }

        /* 修复日期输入框的样式，确保与其他输入框对齐 */
        .form-group input[type="date"] {
            /* 确保日期输入框与其他输入框一致 */
            line-height: 1;
            height: auto;
        }

        /* 新增：确保备注输入框与其他输入框样式一致 */
        .form-group input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            font-size: 14px;
            appearance: none;
            -webkit-appearance: none;
            background-color: white;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions button {
            flex: 1;
        }

        /* 空状态 */
        .empty {
            text-align: center;
            padding: 30px 0;
            color: #8e8e93;
            font-size: 14px;
        }

        /* 提示框 */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            display: none;
            z-index: 1001;
        }

        .toast.show {
            display: block;
            animation: fade 2s ease;
        }

        @keyframes fade {
            0% { opacity: 0; bottom: 20px; }
            10% { opacity: 1; bottom: 30px; }
            90% { opacity: 1; bottom: 30px; }
            100% { opacity: 0; bottom: 20px; }
        }

        /* 底部添加按钮 */
        .add-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: #007aff;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,122,255,0.3);
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <div class="navbar">
        <h1>账单管理</h1>
        <button id="categoryBtn">类别管理</button>
    </div>

    <!-- 统计卡片 -->
    <div class="stats">
        <div class="stat-item">
            <div class="label">总收入</div>
            <div class="value" id="totalIncome">0.00</div>
        </div>
        <div class="stat-item">
            <div class="label">总支出</div>
            <div class="value" id="totalExpense">0.00</div>
        </div>
        <div class="stat-item">
            <div class="label">结余</div>
            <div class="value" id="totalBalance">0.00</div>
        </div>
    </div>

    <!-- 类别预算卡片 -->
    <div class="card">
        <h2>
            类别预算
            <button class="btn-small" id="editBudgetBtn">设置预算</button>
        </h2>
        <div id="budgetList" class="list">
            <div class="empty">暂无类别预算数据</div>
        </div>
    </div>

    <!-- 日期筛选 + 账单列表 -->
    <div class="card">
        <h2>
            近期账单
            <div>
                <input type="date" id="dateFilter" style="padding: 5px; margin-right: 5px;">
                <button class="btn-small" id="toggleBillListBtn">折叠</button>
                <button class="btn-small" id="clearBillsBtn">清空</button>
            </div>
        </h2>
        <div id="billList" class="list">
            <div class="empty">暂无账单数据</div>
        </div>
    </div>

    <!-- 类别管理卡片（点击导航栏按钮显示/隐藏） -->
    <div class="card" id="categoryCard" style="display: none;">
        <h2>
            类别管理
            <button class="btn-small" id="addCategoryBtn">新增类别</button>
        </h2>
        <div id="categoryList" class="list">
            <div class="empty">暂无类别数据</div>
        </div>
    </div>

    <!-- 添加账单模态框 -->
    <div class="modal" id="addBillModal">
        <div class="modal-content">
            <h3>添加账单</h3>
            <div class="form-group">
                <label>类型</label>
                <select id="billType">
                    <option value="expense">支出</option>
                    <option value="income">收入</option>
                </select>
            </div>
            <div class="form-group">
                <label>类别</label>
                <select id="billCategory">
                    <!-- 动态填充 -->
                </select>
            </div>
            <div class="form-group">
                <label>金额（元）</label>
                <input type="number" id="billAmount" step="0.01" min="0.01" placeholder="输入金额">
            </div>
            <div class="form-group">
                <label>日期</label>
                <input type="date" id="billDate" max="">
            </div>
            <!-- 新增：备注输入框 -->
            <div class="form-group">
                <label>备注（可选）</label>
                <input type="text" id="billNote" maxlength="50" placeholder="输入备注信息（最多50字）">
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" id="cancelAddBill">取消</button>
                <button id="saveBillBtn">保存</button>
            </div>
        </div>
    </div>

    <!-- 编辑账单模态框 -->
    <div class="modal" id="editBillModal">
        <div class="modal-content">
            <h3>编辑账单</h3>
            <input type="hidden" id="editBillId">
            <div class="form-group">
                <label>类型</label>
                <select id="editBillType">
                    <option value="expense">支出</option>
                    <option value="income">收入</option>
                </select>
            </div>
            <div class="form-group">
                <label>类别</label>
                <select id="editBillCategory">
                    <!-- 动态填充 -->
                </select>
            </div>
            <div class="form-group">
                <label>金额（元）</label>
                <input type="number" id="editBillAmount" step="0.01" min="0.01" placeholder="输入金额">
            </div>
            <div class="form-group">
                <label>日期</label>
                <input type="date" id="editBillDate" max="">
            </div>
            <!-- 新增：编辑时的备注输入框 -->
            <div class="form-group">
                <label>备注（可选）</label>
                <input type="text" id="editBillNote" maxlength="50" placeholder="输入备注信息（最多50字）">
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" id="cancelEditBill">取消</button>
                <button id="updateBillBtn">保存</button>
            </div>
        </div>
    </div>

    <!-- 新增类别模态框 -->
    <div class="modal" id="addCategoryModal">
        <div class="modal-content">
            <h3>新增类别</h3>
            <div class="form-group">
                <label>类别名称</label>
                <input type="text" id="newCategoryName" maxlength="10" placeholder="输入类别名称">
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" id="cancelAddCategory">取消</button>
                <button id="saveCategoryBtn">保存</button>
            </div>
        </div>
    </div>

    <!-- 设置类别预算模态框 -->
    <div class="modal" id="setBudgetModal">
        <div class="modal-content">
            <h3>设置类别预算</h3>
            <div class="form-group">
                <label>选择类别</label>
                <select id="budgetCategorySelect">
                    <!-- 动态填充 -->
                </select>
            </div>
            <div class="form-group">
                <label>预算金额（元）</label>
                <input type="number" id="budgetAmountInput" step="0.01" min="0.01" placeholder="输入预算金额">
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" id="cancelSetBudget">取消</button>
                <button id="saveBudgetBtn">保存</button>
            </div>
        </div>
    </div>

    <!-- 提示框 -->
    <div class="toast" id="toast"></div>

    <!-- 底部添加按钮 -->
    <button class="add-btn" id="addBillBtn">+</button>

    <script>
        // 存储键名
        const STORAGE = {
            BILLS: 'bills',
            CATEGORIES: 'categories',
            CATEGORY_BUDGETS: 'categoryBudgets'
        };

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 设置今日日期
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('billDate').value = today;
            document.getElementById('dateFilter').value = today;
            
            // 设置日期输入框的最大值为今天（修复问题3）
            document.getElementById('billDate').max = today;
            document.getElementById('editBillDate').max = today;

            // 初始化本地存储
            initStorage();

            // 渲染所有数据
            renderCategories();
            renderCategoryBudgets();
            renderBills();
            renderStats();

            // 绑定所有事件（直接绑定，确保100%响应）
            bindAllEvents();
        });

        // 初始化本地存储
        function initStorage() {
            if (!localStorage.getItem(STORAGE.BILLS)) localStorage.setItem(STORAGE.BILLS, '[]');
            if (!localStorage.getItem(STORAGE.CATEGORIES)) localStorage.setItem(STORAGE.CATEGORIES, '[]');
            if (!localStorage.getItem(STORAGE.CATEGORY_BUDGETS)) localStorage.setItem(STORAGE.CATEGORY_BUDGETS, '{}');
        }

        // 生成唯一ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 8);
        }

        // 显示提示框
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // 获取所有类别
        function getCategories() {
            return JSON.parse(localStorage.getItem(STORAGE.CATEGORIES) || '[]');
        }

        // 获取所有账单
        function getBills() {
            return JSON.parse(localStorage.getItem(STORAGE.BILLS) || '[]');
        }

        // 获取类别预算
        function getCategoryBudgets() {
            return JSON.parse(localStorage.getItem(STORAGE.CATEGORY_BUDGETS) || '{}');
        }

        // 重置添加账单表单（修复问题2）
        function resetAddBillForm() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('billType').value = 'expense';
            document.getElementById('billAmount').value = '';
            document.getElementById('billDate').value = today;
            document.getElementById('billDate').max = today;
            // 新增：重置备注字段
            document.getElementById('billNote').value = '';
            
            // 设置类别为第一个可用类别（如果有的话）
            const categories = getCategories();
            const billCategorySelect = document.getElementById('billCategory');
            if (categories.length > 0 && billCategorySelect.options.length > 0) {
                billCategorySelect.value = categories[0].id;
            }
        }

        // 重置编辑账单表单（修复问题2）
        function resetEditBillForm() {
            // 只重置隐藏的id字段，其他字段会在打开时填充
            document.getElementById('editBillId').value = '';
        }

        // 渲染类别列表（用于类别管理和下拉选择）
        function renderCategories() {
            const categories = getCategories();
            const categoryList = document.getElementById('categoryList');
            const billCategory = document.getElementById('billCategory');
            const editBillCategory = document.getElementById('editBillCategory');
            const budgetCategorySelect = document.getElementById('budgetCategorySelect');

            // 清空下拉框
            billCategory.innerHTML = '';
            editBillCategory.innerHTML = '';
            budgetCategorySelect.innerHTML = '';

            // 空状态
            if (categories.length === 0) {
                categoryList.innerHTML = '<div class="empty">暂无类别数据</div>';
                return;
            }

            // 渲染类别管理列表
            categoryList.innerHTML = '';
            categories.forEach(cat => {
                // 类别管理项
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="info">
                        <div class="name">${cat.name}</div>
                    </div>
                    <div class="actions">
                        <button class="btn-small edit-category" data-id="${cat.id}">编辑</button>
                        <button class="btn-small delete-category" data-id="${cat.id}">删除</button>
                    </div>
                `;
                categoryList.appendChild(item);

                // 填充下拉框
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                billCategory.appendChild(option.cloneNode(true));
                editBillCategory.appendChild(option.cloneNode(true));
                budgetCategorySelect.appendChild(option);
            });
        }

        // 渲染类别预算
        function renderCategoryBudgets() {
            const budgets = getCategoryBudgets();
            const categories = getCategories();
            const budgetList = document.getElementById('budgetList');

            // 筛选有预算的类别
            const budgetItems = categories.filter(cat => budgets[cat.id] && budgets[cat.id].amount > 0);

            if (budgetItems.length === 0) {
                budgetList.innerHTML = '<div class="empty">暂无类别预算数据</div>';
                return;
            }

            budgetList.innerHTML = '';
            budgetItems.forEach(cat => {
                const budget = budgets[cat.id];
                const used = parseFloat(budget.used || 0);
                const amount = parseFloat(budget.amount);
                const remaining = amount - used;
                const progress = Math.min(100, Math.round((used / amount) * 100));

                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="info" style="width: 100%;">
                        <div class="name">${cat.name}</div>
                        <div class="progress-container">
                            <div class="progress-bar ${remaining < 0 ? 'over' : ''}" style="width: ${progress}%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; margin-top: 5px;">
                            <span>已用: ¥${used.toFixed(2)}</span>
                            <span>${remaining < 0 ? '超支: ¥' + Math.abs(remaining).toFixed(2) : '剩余: ¥' + remaining.toFixed(2)}</span>
                            <span>预算: ¥${amount.toFixed(2)}</span>
                        </div>
                    </div>
                `;
                budgetList.appendChild(item);
            });
        }

        // 渲染账单列表
        function renderBills(filterDate = '') {
            let bills = getBills();
            const categories = getCategories();
            const billList = document.getElementById('billList');

            // 日期筛选
            if (filterDate) {
                bills = bills.filter(bill => bill.date === filterDate);
            }

            if (bills.length === 0) {
                billList.innerHTML = '<div class="empty">暂无账单数据</div>';
                return;
            }

            billList.innerHTML = '';
            bills.forEach(bill => {
                const cat = categories.find(c => c.id === bill.categoryId) || { name: '未知类别' };
                const item = document.createElement('div');
                item.className = 'list-item';
                
                // 如果有备注，在描述部分显示备注，否则显示日期
                const descText = bill.note ? `${bill.date} | ${bill.note}` : bill.date;
                
                item.innerHTML = `
                    <div class="info">
                        <div class="name">${cat.name} ${bill.type === 'income' ? '(收入)' : '(支出)'}</div>
                        <div class="desc">${descText}</div>
                    </div>
                    <div class="actions">
                        <span style="font-weight: 600; ${bill.type === 'income' ? 'color: #34c759' : 'color: #ff3b30'}">
                            ${bill.type === 'income' ? '+' : '-'}¥${bill.amount.toFixed(2)}
                        </span>
                        <button class="btn-small edit-bill" data-id="${bill.id}">编辑</button>
                        <button class="btn-small delete-bill" data-id="${bill.id}">删除</button>
                    </div>
                `;
                billList.appendChild(item);
            });
        }

        // 渲染统计数据
        function renderStats() {
            const bills = getBills();
            let income = 0, expense = 0;

            bills.forEach(bill => {
                const amount = parseFloat(bill.amount);
                if (bill.type === 'income') {
                    income += amount;
                } else {
                    expense += amount;
                }
            });

            // 更新统计
            document.getElementById('totalIncome').textContent = income.toFixed(2);
            document.getElementById('totalExpense').textContent = expense.toFixed(2);
            document.getElementById('totalBalance').textContent = (income - expense).toFixed(2);

            // 更新类别预算的已使用金额
            updateCategoryBudgetUsed();
        }

        // 更新类别预算的已使用金额
        function updateCategoryBudgetUsed() {
            const bills = getBills();
            const budgets = getCategoryBudgets();
            const categories = getCategories();

            // 重置已使用金额
            categories.forEach(cat => {
                if (!budgets[cat.id]) budgets[cat.id] = { amount: 0, used: 0 };
                budgets[cat.id].used = 0;
            });

            // 统计支出
            bills.forEach(bill => {
                if (bill.type === 'expense' && budgets[bill.categoryId]) {
                    budgets[bill.categoryId].used += parseFloat(bill.amount);
                }
            });

            // 保存并重新渲染预算
            localStorage.setItem(STORAGE.CATEGORY_BUDGETS, JSON.stringify(budgets));
            renderCategoryBudgets();
        }

        // 绑定所有事件（核心：直接绑定，无委托冲突）
        function bindAllEvents() {
            // ========== 基础按钮 ==========
            // 显示/隐藏类别管理卡片
            document.getElementById('categoryBtn').addEventListener('click', function() {
                const card = document.getElementById('categoryCard');
                card.style.display = card.style.display === 'none' ? 'block' : 'none';
            });

            // 打开添加账单模态框（修复问题2和3）
            document.getElementById('addBillBtn').addEventListener('click', function() {
                const categories = getCategories();
                if (categories.length === 0) {
                    showToast('请先添加类别');
                    return;
                }
                // 重置表单（修复问题2）
                resetAddBillForm();
                document.getElementById('addBillModal').classList.add('show');
            });

            // 取消添加账单（修复问题2）
            document.getElementById('cancelAddBill').addEventListener('click', function() {
                document.getElementById('addBillModal').classList.remove('show');
                // 重置表单以便下次打开时是干净的状态
                resetAddBillForm();
            });

            // 保存账单（修复问题3：添加日期校验）
            document.getElementById('saveBillBtn').addEventListener('click', function() {
                const type = document.getElementById('billType').value;
                const categoryId = document.getElementById('billCategory').value;
                const amount = parseFloat(document.getElementById('billAmount').value);
                const date = document.getElementById('billDate').value;
                // 新增：获取备注内容
                const note = document.getElementById('billNote').value.trim();
                
                // 获取今天的日期
                const today = new Date().toISOString().split('T')[0];
                
                // 校验（修复问题3：添加未来日期校验）
                if (!categoryId) return showToast('请选择类别');
                if (isNaN(amount) || amount < 0.01) return showToast('金额必须大于0.01元');
                if (!date) return showToast('请选择日期');
                if (date > today) return showToast('不能选择未来日期');

                // 保存账单（新增note字段）
                const bills = getBills();
                bills.push({
                    id: generateId(),
                    type,
                    categoryId,
                    amount,
                    date,
                    note: note || ''  // 备注可以为空
                });
                localStorage.setItem(STORAGE.BILLS, JSON.stringify(bills));

                // 重新渲染
                renderBills(document.getElementById('dateFilter').value);
                renderStats();
                document.getElementById('addBillModal').classList.remove('show');
                // 重置表单以便下次打开时是干净的状态
                resetAddBillForm();
                showToast('账单添加成功');
            });

            // ========== 折叠/展开账单列表 ==========
            document.getElementById('toggleBillListBtn').addEventListener('click', function() {
                const billList = document.getElementById('billList');
                billList.classList.toggle('hidden');
                this.textContent = billList.classList.contains('hidden') ? '展开' : '折叠';
            });

            // ========== 类别管理 ==========
            // 打开新增类别模态框
            document.getElementById('addCategoryBtn').addEventListener('click', function() {
                document.getElementById('addCategoryModal').classList.add('show');
            });

            // 取消新增类别
            document.getElementById('cancelAddCategory').addEventListener('click', function() {
                document.getElementById('addCategoryModal').classList.remove('show');
            });

            // 保存类别
            document.getElementById('saveCategoryBtn').addEventListener('click', function() {
                const name = document.getElementById('newCategoryName').value.trim();
                if (!name || name.length > 10) return showToast('请输入1-10个字的类别名称');

                // 重名校验
                const categories = getCategories();
                if (categories.some(c => c.name === name)) return showToast('类别名称已存在');

                // 保存类别
                categories.push({ id: generateId(), name });
                localStorage.setItem(STORAGE.CATEGORIES, JSON.stringify(categories));

                // 初始化该类别的预算
                const budgets = getCategoryBudgets();
                budgets[categories[categories.length - 1].id] = { amount: 0, used: 0 };
                localStorage.setItem(STORAGE.CATEGORY_BUDGETS, JSON.stringify(budgets));

                // 重新渲染
                renderCategories();
                document.getElementById('addCategoryModal').classList.remove('show');
                document.getElementById('newCategoryName').value = '';
                showToast('类别添加成功');
            });

            // 编辑类别（事件委托，确保新增类别后也能响应）
            document.getElementById('categoryList').addEventListener('click', function(e) {
                // 编辑类别
                if (e.target.classList.contains('edit-category')) {
                    const id = e.target.dataset.id;
                    const categories = getCategories();
                    const cat = categories.find(c => c.id === id);
                    if (!cat) return;

                    const newName = prompt('请输入新的类别名称', cat.name);
                    if (!newName || newName.trim() === '' || newName.length > 10) return;
                    if (categories.some(c => c.id !== id && c.name === newName.trim())) {
                        return showToast('类别名称已存在');
                    }

                    // 更新名称
                    const updated = categories.map(c => c.id === id ? { ...c, name: newName.trim() } : c);
                    localStorage.setItem(STORAGE.CATEGORIES, JSON.stringify(updated));
                    renderCategories();
                    renderCategoryBudgets();
                    showToast('类别编辑成功');
                }

                // 删除类别
                if (e.target.classList.contains('delete-category')) {
                    const id = e.target.dataset.id;
                    if (!confirm('确定删除该类别？关联账单将显示为未知类别')) return;

                    // 删除类别
                    const categories = getCategories().filter(c => c.id !== id);
                    localStorage.setItem(STORAGE.CATEGORIES, JSON.stringify(categories));

                    // 删除对应预算
                    const budgets = getCategoryBudgets();
                    delete budgets[id];
                    localStorage.setItem(STORAGE.CATEGORY_BUDGETS, JSON.stringify(budgets));

                    // 重新渲染
                    renderCategories();
                    renderCategoryBudgets();
                    showToast('类别删除成功');
                }
            });

            // ========== 预算管理 ==========
            // 打开设置预算模态框
            document.getElementById('editBudgetBtn').addEventListener('click', function() {
                const categories = getCategories();
                if (categories.length === 0) {
                    showToast('请先添加类别');
                    return;
                }
                document.getElementById('setBudgetModal').classList.add('show');
            });

            // 取消设置预算
            document.getElementById('cancelSetBudget').addEventListener('click', function() {
                document.getElementById('setBudgetModal').classList.remove('show');
            });

            // 保存预算
            document.getElementById('saveBudgetBtn').addEventListener('click', function() {
                const categoryId = document.getElementById('budgetCategorySelect').value;
                const amount = parseFloat(document.getElementById('budgetAmountInput').value);

                if (!categoryId) return showToast('请选择类别');
                if (isNaN(amount) || amount < 0.01) return showToast('预算金额必须大于0.01元');

                // 保存预算
                const budgets = getCategoryBudgets();
                if (!budgets[categoryId]) budgets[categoryId] = { amount: 0, used: 0 };
                budgets[categoryId].amount = amount;
                localStorage.setItem(STORAGE.CATEGORY_BUDGETS, JSON.stringify(budgets));

                // 重新渲染
                renderCategoryBudgets();
                document.getElementById('setBudgetModal').classList.remove('show');
                document.getElementById('budgetAmountInput').value = '';
                showToast('预算设置成功');
            });

            // ========== 账单管理 ==========
            // 日期筛选
            document.getElementById('dateFilter').addEventListener('change', function() {
                renderBills(this.value);
            });

            // 清空账单
            document.getElementById('clearBillsBtn').addEventListener('click', function() {
                if (!confirm('确定清空所有账单？')) return;
                localStorage.setItem(STORAGE.BILLS, '[]');
                renderBills();
                renderStats();
                showToast('账单已清空');
            });

            // 账单编辑/删除（事件委托）- 修复问题1：无法删除"未知类别"账单
            document.getElementById('billList').addEventListener('click', function(e) {
                // 编辑账单 - 使用closest确保点击到按钮任何部分都能触发
                const editBtn = e.target.closest('.edit-bill');
                if (editBtn) {
                    const id = editBtn.dataset.id;
                    const bills = getBills();
                    const bill = bills.find(b => b.id === id);
                    if (!bill) return;

                    // 填充编辑表单（新增备注字段）
                    document.getElementById('editBillId').value = bill.id;
                    document.getElementById('editBillType').value = bill.type;
                    document.getElementById('editBillCategory').value = bill.categoryId;
                    document.getElementById('editBillAmount').value = bill.amount;
                    document.getElementById('editBillDate').value = bill.date;
                    // 新增：填充备注字段
                    document.getElementById('editBillNote').value = bill.note || '';
                    
                    // 设置最大日期为今天（修复问题3）
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('editBillDate').max = today;

                    // 打开编辑模态框
                    document.getElementById('editBillModal').classList.add('show');
                }

                // 删除账单 - 修复问题1：确保"未知类别"账单也能删除
                const deleteBtn = e.target.closest('.delete-bill');
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    if (!confirm('确定删除该账单？')) return;

                    // 删除账单 - 修复问题1：不需要检查类别是否存在，直接根据id删除
                    const bills = getBills().filter(b => b.id !== id);
                    localStorage.setItem(STORAGE.BILLS, JSON.stringify(bills));

                    // 重新渲染
                    renderBills(document.getElementById('dateFilter').value);
                    renderStats();
                    showToast('账单删除成功');
                }
            });

            // 取消编辑账单（修复问题2）
            document.getElementById('cancelEditBill').addEventListener('click', function() {
                document.getElementById('editBillModal').classList.remove('show');
                // 重置表单以便下次打开时是干净的状态
                resetEditBillForm();
            });

            // 更新账单（修复问题3：添加日期校验）
            document.getElementById('updateBillBtn').addEventListener('click', function() {
                const id = document.getElementById('editBillId').value;
                const type = document.getElementById('editBillType').value;
                const categoryId = document.getElementById('editBillCategory').value;
                const amount = parseFloat(document.getElementById('editBillAmount').value);
                const date = document.getElementById('editBillDate').value;
                // 新增：获取备注内容
                const note = document.getElementById('editBillNote').value.trim();
                
                // 获取今天的日期
                const today = new Date().toISOString().split('T')[0];
                
                // 校验（修复问题3：添加未来日期校验）
                if (!categoryId) return showToast('请选择类别');
                if (isNaN(amount) || amount < 0.01) return showToast('金额必须大于0.01元');
                if (!date) return showToast('请选择日期');
                if (date > today) return showToast('不能选择未来日期');

                // 更新账单（包括备注字段）
                const bills = getBills().map(b => {
                    if (b.id === id) {
                        return { ...b, type, categoryId, amount, date, note: note || '' };
                    }
                    return b;
                });
                localStorage.setItem(STORAGE.BILLS, JSON.stringify(bills));

                // 重新渲染
                renderBills(document.getElementById('dateFilter').value);
                renderStats();
                document.getElementById('editBillModal').classList.remove('show');
                // 重置表单以便下次打开时是干净的状态
                resetEditBillForm();
                showToast('账单编辑成功');
            });
        }
    </script>
</body>
</html>
