<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
    <title>å¦ä¸€ä¸ªæˆ‘</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-user-select: none; }
        body { background: #F2F2F7; padding-bottom: 90px; }

        /* å¯†ç é” */
        .lock-screen { position: fixed; top:0; left:0; right:0; bottom:0; background: #F2F2F7; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0 20px; }
        .lock-title { font-size: 20px; margin-bottom: 30px; }
        .password-inputs { display: flex; gap: 15px; width: 100%; max-width: 300px; }
        .password-input { width: 20%; height: 50px; border: 2px solid #ccc; border-radius: 12px; text-align: center; font-size: 28px; }

        /* ä¸»é¡µé¢ */
        .main-title { padding: 20px 16px; font-size: 24px; font-weight: 600; }
        .stats-card { background: #fff; border-radius: 16px; margin: 0 16px 16px; padding: 16px; }
        .stats-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .stats-label { color: #888; }
        .stats-value.expense { color: #ff3b30; }
        .stats-value.income { color: #34c759; }

        /* è´¦å•æ»‘åŠ¨åˆ é™¤æ ¸å¿ƒæ ·å¼ï¼ˆå¿…çœ‹ï¼‰ */
        .bill-item-wrap {
            position: relative;
            width: 100%;
            height: 70px;
            margin: 0 16px 10px;
            overflow: hidden !important; /* å¼ºåˆ¶éšè—æº¢å‡º */
            border-radius: 12px;
        }
        .bill-item {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #fff;
            display: flex; align-items: center;
            padding: 0 16px;
            transition: left 0.15s ease; /* å¿«é€Ÿæ»‘åŠ¨åŠ¨ç”» */
            z-index: 2;
        }
        .bill-delete {
            position: absolute;
            top: 0; right: 0;
            width: 80px; height: 100%;
            background: #ff3b30; color: #fff;
            border: none; font-size: 16px;
            z-index: 1;
        }
        .bill-icon { width: 36px; height: 36px; background: #eee; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 10px; }
        .bill-info { flex: 1; }
        .bill-amount { font-weight: 500; }
        .bill-amount.expense { color: #ff3b30; }

        .add-btn { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: #000; color: #fff; font-size: 36px; border: none; display: flex; align-items: center; justify-content: center; }
        .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); display: none; z-index: 100; }
        .modal.show { display: block; }
        .modal-content { position: fixed; bottom:0; left:0; right:0; background: #fff; border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 24px 16px; }
    </style>
</head>
<body>
    <!-- å¯†ç é” -->
    <div class="lock-screen" id="lockScreen">
        <div class="lock-title">è¯·è¾“å…¥4ä½æ•°å­—å¯†ç </div>
        <div class="password-inputs">
            <input type="password" class="pwd" maxlength="1" oninput="next(this)">
            <input type="password" class="pwd" maxlength="1" oninput="next(this)">
            <input type="password" class="pwd" maxlength="1" oninput="next(this)">
            <input type="password" class="pwd" maxlength="1" oninput="check()">
        </div>
    </div>

    <!-- ä¸»é¡µé¢ -->
    <div id="main" style="display: none;">
        <div class="main-title">å¦ä¸€ä¸ªæˆ‘</div>
        <!-- æ”¶æ”¯ç»Ÿè®¡ -->
        <div class="stats-card">
            <div class="stats-row">
                <div class="stats-label">æœ¬æœˆæ”¯å‡º</div>
                <div class="stats-value expense" id="expense">Â¥0.00</div>
            </div>
            <div class="stats-row">
                <div class="stats-label">æœ¬æœˆæ”¶å…¥</div>
                <div class="stats-value income" id="income">Â¥0.00</div>
            </div>
        </div>
        <!-- è´¦å•åˆ—è¡¨ -->
        <div style="padding: 0 16px;">
            <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">æœ€è¿‘è´¦å•</div>
            <div id="billList">
                <div style="text-align: center; padding: 30px 0; color: #888;">æš‚æ— è´¦å•ï¼Œç‚¹å‡»+å¼€å§‹è®°å½•</div>
            </div>
        </div>
        <!-- +å·æŒ‰é’® -->
        <button class="add-btn" onclick="openModal()">+</button>

        <!-- è®°è´¦å¼¹çª— -->
        <div class="modal" id="billModal">
            <div class="modal-content">
                <h2 style="text-align: center; margin-bottom: 20px;">è®°ä¸€ç¬”</h2>
                <input type="number" id="amount" placeholder="è¾“å…¥é‡‘é¢" style="width:100%; font-size:24px; text-align:center; margin:10px 0;">
                <div style="display:flex; gap:10px; margin:10px 0;">
                    <button onclick="setType('expense')" style="flex:1; padding:8px; background:#000; color:#fff; border:none; border-radius:20px;">æ”¯å‡º</button>
                    <button onclick="setType('income')" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:20px;">æ”¶å…¥</button>
                </div>
                <div style="margin:10px 0;">
                    <div>åˆ†ç±»</div>
                    <div style="display:grid; grid-template-columns: repeat(4,1fr); gap:10px; margin:10px 0;" id="cateGrid"></div>
                    <button onclick="addCate()" style="width:100%; padding:8px; border:1px dashed #ccc; border-radius:8px;">+ æ–°å¢åˆ†ç±»</button>
                </div>
                <button onclick="save()" style="width:100%; padding:10px; background:#000; color:#fff; border:none; border-radius:8px; margin-top:10px;">ä¿å­˜</button>
                <button onclick="closeModal()" style="width:100%; padding:10px; margin-top:10px; border:none; background:#eee; border-radius:8px;">å…³é—­</button>
            </div>
        </div>

        <!-- æ–°å¢åˆ†ç±»å¼¹çª— -->
        <div class="modal" id="cateModal" style="align-items: center; justify-content: center; display: none;">
            <div style="background:#fff; padding:20px; border-radius:16px; width:80%;">
                <input type="text" id="newCate" placeholder="è¾“å…¥åˆ†ç±»åç§°" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:8px; margin:10px 0;">
                <div style="display:flex; gap:10px;">
                    <button onclick="saveCate()" style="flex:1; padding:8px; background:#000; color:#fff; border:none; border-radius:8px;">ç¡®è®¤</button>
                    <button onclick="closeCateModal()" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:8px;">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åŸºç¡€å˜é‡
        let pwd = '0517';
        let type = 'expense';
        let selectedCate = '';
        let cates = JSON.parse(localStorage.getItem('cates')) || ['é¤é¥®ğŸœ','äº¤é€šğŸšŒ','å¨±ä¹ğŸ¬','å­¦ä¹ ğŸ“š'];
        let bills = JSON.parse(localStorage.getItem('bills')) || [];
        // æ»‘åŠ¨å˜é‡ï¼ˆæç®€ç‰ˆï¼‰
        let startX = 0;
        let currentBill = null;

        // å¯†ç åŠŸèƒ½
        function next(input) {
            const inputs = document.querySelectorAll('.pwd');
            const idx = Array.from(inputs).indexOf(input);
            if(input.value && idx < 3) inputs[idx+1].focus();
        }
        function check() {
            const val = Array.from(document.querySelectorAll('.pwd')).map(i=>i.value).join('');
            if(val === pwd) {
                document.getElementById('lockScreen').style.display = 'none';
                document.getElementById('main').style.display = 'block';
                renderBill();
            } else {
                alert('æ•°å­—å¯†ç é”™è¯¯');
                document.querySelectorAll('.pwd').forEach(i=>i.value='');
            }
        }

        // æ¸²æŸ“è´¦å•ï¼ˆæ ¸å¿ƒï¼šæ»‘åŠ¨åˆ é™¤ï¼‰
        function renderBill() {
            // è®¡ç®—æ”¶æ”¯
            let exp = 0, inc = 0;
            const month = new Date().getMonth()+1;
            bills.forEach(b => {
                const bMonth = new Date(b.date).getMonth()+1;
                if(bMonth === month) {
                    if(b.type === 'expense') exp += parseFloat(b.amount);
                    else inc += parseFloat(b.amount);
                }
            });
            document.getElementById('expense').innerText = `Â¥${exp.toFixed(2)}`;
            document.getElementById('income').innerText = `Â¥${inc.toFixed(2)}`;

            // æ¸²æŸ“è´¦å•åˆ—è¡¨
            const list = document.getElementById('billList');
            if(bills.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 30px 0; color: #888;">æš‚æ— è´¦å•ï¼Œç‚¹å‡»+å¼€å§‹è®°å½•</div>';
                return;
            }
            list.innerHTML = '';
            bills.forEach((b, idx) => {
                // æ»‘åŠ¨å®¹å™¨ï¼ˆå¿…åŠ overflow:hiddenï¼‰
                const wrap = document.createElement('div');
                wrap.className = 'bill-item-wrap';
                
                // è´¦å•ä¸»ä½“
                const item = document.createElement('div');
                item.className = 'bill-item';
                item.innerHTML = `
                    <div class="bill-icon">${b.cate.match(/[^\u4e00-\u9fa5]/g).join('')}</div>
                    <div class="bill-info">
                        <div>${b.cate.replace(/[^\u4e00-\u9fa5]/g, '')}</div>
                        <div style="font-size:12px; color:#888;">${b.date}</div>
                    </div>
                    <div class="bill-amount ${b.type}">${b.type==='expense'?'-':'+'}Â¥${b.amount}</div>
                `;

                // åˆ é™¤æŒ‰é’®
                const delBtn = document.createElement('button');
                delBtn.className = 'bill-delete';
                delBtn.innerText = 'åˆ é™¤';
                delBtn.onclick = () => {
                    if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
                        bills.splice(idx, 1);
                        localStorage.setItem('bills', JSON.stringify(bills));
                        renderBill();
                    } else {
                        item.style.left = '0'; // å–æ¶ˆåˆ é™¤ï¼Œé‡ç½®ä½ç½®
                    }
                };

                // ========== æç®€æ»‘åŠ¨äº‹ä»¶ï¼ˆæ‰‹æœºç«¯100%è§¦å‘ï¼‰ ==========
                // è§¦æ‘¸å¼€å§‹
                item.ontouchstart = (e) => {
                    startX = e.touches[0].clientX;
                    currentBill = item;
                    // é‡ç½®æ‰€æœ‰è´¦å•ä½ç½®
                    document.querySelectorAll('.bill-item').forEach(i => i.style.left = '0');
                };
                // è§¦æ‘¸ç§»åŠ¨
                item.ontouchmove = (e) => {
                    if(!currentBill) return;
                    const moveX = e.touches[0].clientX;
                    const diff = startX - moveX; // å³æ»‘diffä¸ºæ­£
                    // åªå…è®¸å³æ»‘ï¼Œæœ€å¤§æ»‘80px
                    if(diff > 0 && diff <= 80) {
                        currentBill.style.left = `-${diff}px`;
                    }
                };
                // è§¦æ‘¸ç»“æŸ
                item.ontouchend = () => {
                    if(!currentBill) return;
                    const left = parseInt(currentBill.style.left) || 0;
                    // æ»‘è¶…è¿‡20pxå°±å±•å¼€åˆ é™¤æŒ‰é’®ï¼ˆé˜ˆå€¼é™ä½ï¼Œæ›´å®¹æ˜“è§¦å‘ï¼‰
                    if(Math.abs(left) >= 20) {
                        currentBill.style.left = '-80px';
                    } else {
                        currentBill.style.left = '0';
                    }
                    currentBill = null;
                };

                // ç»„è£…DOM
                wrap.appendChild(item);
                wrap.appendChild(delBtn);
                list.appendChild(wrap);
            });
        }

        // è®°è´¦å¼¹çª—
        function openModal() {
            renderCate();
            document.getElementById('billModal').classList.add('show');
        }
        function closeModal() {
            document.getElementById('billModal').classList.remove('show');
            document.getElementById('amount').value = '';
        }
        function setType(t) {
            type = t;
        }

        // åˆ†ç±»åŠŸèƒ½
        function renderCate() {
            const grid = document.getElementById('cateGrid');
            grid.innerHTML = '';
            cates.forEach((c, idx) => {
                const item = document.createElement('div');
                item.style.textAlign = 'center';
                item.innerHTML = `<div style="width:40px; height:40px; background:#eee; border-radius:8px; margin:auto; display:flex; align-items:center; justify-content:center;">${c}</div>`;
                item.onclick = () => {
                    document.querySelectorAll('#cateGrid>div').forEach(i => i.style.opacity = '0.5');
                    item.style.opacity = '1';
                    selectedCate = c;
                };
                // é•¿æŒ‰åˆ é™¤åˆ†ç±»
                item.ontouchstart = () => {
                    setTimeout(() => {
                        if(cates.length>1 && confirm(`åˆ é™¤${c}ï¼Ÿ`)) {
                            cates.splice(idx,1);
                            localStorage.setItem('cates', JSON.stringify(cates));
                            renderCate();
                        }
                    }, 500);
                };
                grid.appendChild(item);
            });
            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
            if(cates.length>0) {
                document.querySelector('#cateGrid>div').style.opacity = '1';
                selectedCate = cates[0];
            }
        }
        function addCate() {
            document.getElementById('cateModal').style.display = 'flex';
        }
        function closeCateModal() {
            document.getElementById('cateModal').style.display = 'none';
            document.getElementById('newCate').value = '';
        }
        function saveCate() {
            const name = document.getElementById('newCate').value.trim();
            if(!name) return alert('è¾“å…¥åˆ†ç±»å');
            cates.push(name + ['ğŸ¥¤','ğŸ“±','â˜•'][Math.floor(Math.random()*3)]);
            localStorage.setItem('cates', JSON.stringify(cates));
            renderCate();
            closeCateModal();
        }

        // ä¿å­˜è´¦å•
        function save() {
            const amount = document.getElementById('amount').value;
            if(!amount || amount<=0) return alert('é‡‘é¢å¤§äº0');
            if(!selectedCate) return alert('é€‰åˆ†ç±»');
            bills.unshift({
                id: Date.now(),
                cate: selectedCate,
                amount: amount,
                type: type,
                date: new Date().toISOString().split('T')[0]
            });
            localStorage.setItem('bills', JSON.stringify(bills));
            alert('è®°è´¦æˆåŠŸ');
            closeModal();
            renderBill();
        }

        // æ‰‹æœºç«¯é˜²ç¼©æ”¾
        document.addEventListener('touchmove', (e) => {
            if (e.scale !== 1) e.preventDefault();
        }, { passive: false });
    </script>
</body>
</html>
