<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
    <title>å¦ä¸€ä¸ªæˆ‘</title>
    <style>
        /* å…¨å±€é‡ç½® */
        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            -webkit-user-select: none; user-select: none;
        }
        body { 
            background: #F2F2F7; 
            padding-bottom: 90px; 
            font-size: 16px; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; /* iOSåŸç”Ÿå­—ä½“ */
        }

        /* å¯†ç é” */
        .lock-screen {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: #F2F2F7; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 0 20px;
        }
        .lock-title {
            font-size: 20px; color: #1C1C1E; margin-bottom: 30px;
        }
        .password-inputs { 
            display: flex; gap: 15px; margin-bottom: 20px;
            width: 100%; max-width: 300px;
        }
        .password-input {
            width: 20%; height: 50px; 
            border: 2px solid #E5E5EA; border-radius: 12px;
            text-align: center; font-size: 28px;
            background: #fff;
            -webkit-appearance: none; appearance: none;
        }
        .password-input:focus { border-color: #1C1C1E; outline: none; }

        /* ä¸»é¡µé¢ */
        .main-title {
            padding: 20px 16px;
            font-size: 24px; font-weight: 600;
            color: #1C1C1E;
        }

        /* æ”¶æ”¯ç»Ÿè®¡å¡ç‰‡ */
        .stats-card {
            background: #fff;
            border-radius: 16px;
            margin: 0 16px 16px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .stats-row {
            display: flex; justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #F2F2F7;
        }
        .stats-row:last-child { border-bottom: none; }
        .stats-label {
            font-size: 16px; color: #8E8E93;
        }
        .stats-value {
            font-size: 18px; font-weight: 600;
        }
        .stats-value.expense { color: #FF3B30; }
        .stats-value.income { color: #34C759; }

        /* ========== iOSåŸç”Ÿæ—¥å†1:1å¤åˆ»æ ·å¼ ========== */
        .calendar-section {
            background: #fff;
            border-radius: 16px;
            margin: 0 16px 16px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        /* iOSæ—¥å†å¤´éƒ¨ï¼ˆæœˆä»½åˆ‡æ¢+æ ‡é¢˜ï¼‰ */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .calendar-nav {
            display: flex;
            gap: 8px;
        }
        /* iOSé£æ ¼ç®­å¤´æŒ‰é’®ï¼ˆæç®€æ— èƒŒæ™¯ï¼Œç‚¹å‡»æœ‰é«˜äº®ï¼‰ */
        .calendar-nav-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #007AFF; /* iOSç³»ç»Ÿè“è‰² */
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: rgba(0, 122, 255, 0.1);
        }
        .calendar-month-text {
            font-size: 17px;
            font-weight: 500;
            color: #1C1C1E;
        }
        /* iOSæ—¥å†æ˜ŸæœŸæ ï¼ˆå‘¨æ—¥çº¢è‰²ï¼‰ */
        .calendar-week {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            margin-bottom: 8px;
        }
        .calendar-week-item {
            font-size: 12px;
            padding: 4px 0;
            color: #8E8E93;
        }
        .calendar-week-item:first-child {
            color: #FF3B30; /* iOSæ—¥å†å‘¨æ—¥çº¢è‰² */
        }
        /* iOSæ—¥å†æ—¥æœŸç½‘æ ¼ */
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        /* iOSæ—¥æœŸæ ·å¼ï¼ˆåœ†å½¢ç‚¹å‡»æ€ã€ä»Šæ—¥åœˆçº¿ã€é€‰ä¸­è“åº•ï¼‰ */
        .calendar-day {
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%; /* iOSåœ†å½¢æ—¥æœŸ */
            font-size: 14px;
            color: #1C1C1E;
            background: transparent;
            -webkit-tap-highlight-color: rgba(0, 122, 255, 0.1);
        }
        /* ç©ºæ—¥æœŸï¼ˆä¸Šæœˆ/ä¸‹æœˆï¼‰ */
        .calendar-day.empty {
            color: #C7C7CC;
        }
        /* iOSä»Šæ—¥æ ·å¼ï¼šç°è‰²è¾¹æ¡†åœˆ */
        .calendar-day.today {
            border: 1px solid #8E8E93;
            font-weight: 500;
        }
        /* æœ‰è´¦å•çš„æ—¥æœŸï¼šåº•éƒ¨å°çº¢ç‚¹ï¼ˆiOSåŒæ¬¾ï¼‰ */
        .calendar-day.has-bill {
            position: relative;
        }
        .calendar-day.has-bill::after {
            content: '';
            position: absolute;
            bottom: 2px;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #FF3B30;
        }
        /* iOSé€‰ä¸­æ—¥æœŸï¼šè“è‰²èƒŒæ™¯+ç™½è‰²æ–‡å­— */
        .calendar-day.active {
            background: #007AFF;
            color: #fff;
            font-weight: 500;
        }
        /* é€‰ä¸­æ—¥æœŸæç¤º */
        .selected-date-tip {
            text-align: center;
            padding: 8px 0 0;
            font-size: 14px;
            color: #8E8E93;
        }

        /* æœ€è¿‘è´¦å•åŒºåŸŸ */
        .bills-section {
            padding: 0 16px;
        }
        .bills-title {
            font-size: 16px; font-weight: 600;
            margin-bottom: 10px;
        }
        .bills-empty {
            text-align: center;
            padding: 30px 0;
            color: #8E8E93;
            font-size: 14px;
        }

        /* è´¦å•æ»‘åŠ¨åˆ é™¤å®¹å™¨ï¼ˆiOSåŸç”Ÿåƒåœ¾æ¡¶ï¼‰ */
        .bill-swipe-container {
            position: relative;
            width: 100%;
            margin-bottom: 10px;
            overflow: hidden;
            border-radius: 12px;
        }
        .bill-item {
            background: #fff;
            padding: 12px 16px;
            display: flex; justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.03);
            position: relative;
            left: 0;
            transition: left 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); /* iOSå¼¹æ€§åŠ¨ç”» */
            z-index: 2;
        }
        /* iOSåŸç”ŸåŒæ¬¾ï¼šåœ†å½¢çº¢è‰²åƒåœ¾æ¡¶æŒ‰é’®ï¼ˆCSSç»˜åˆ¶åŸç”Ÿå›¾æ ‡ï¼‰ */
        .bill-delete-btn {
            position: absolute;
            top: 50%; right: 10px;
            transform: translateY(-50%);
            width: 44px; height: 44px;
            background: #FF3B30;
            color: #fff;
            border: none;
            border-radius: 50%; /* åœ†å½¢ */
            font-size: 20px;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            /* æ¸…é™¤é»˜è®¤æ ·å¼ */
            padding: 0;
            outline: none;
        }
        /* CSSç»˜åˆ¶iOSåŸç”Ÿåƒåœ¾æ¡¶å›¾æ ‡ï¼ˆæç®€çº¿æ¡ï¼‰ */
        .bill-delete-btn::before,
        .bill-delete-btn::after {
            content: '';
            position: absolute;
            background: #fff;
            border-radius: 1px; /* iOSåŸç”Ÿåœ†è§’ */
        }
        /* åƒåœ¾æ¡¶ä¸»ä½“ */
        .bill-delete-btn::before {
            width: 14px;
            height: 10px;
            border: 2px solid #fff;
            border-bottom: none;
            border-radius: 2px 2px 0 0;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
        }
        /* åƒåœ¾æ¡¶åº•éƒ¨ */
        .bill-delete-btn::after {
            width: 18px;
            height: 2px;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
        }

        .bill-left {
            display: flex; align-items: center;
        }
        .bill-icon {
            width: 36px; height: 36px;
            background: #F2F2F7; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            margin-right: 10px;
            font-size: 16px;
        }
        .bill-info {
            display: flex; flex-direction: column;
        }
        .bill-category {
            font-size: 14px; font-weight: 500;
        }
        .bill-date {
            font-size: 12px; color: #8E8E93;
        }
        .bill-amount {
            font-size: 15px; font-weight: 500;
        }
        .bill-amount.expense { color: #FF3B30; }
        .bill-amount.income { color: #34C759; }

        /* åº•éƒ¨+å·æŒ‰é’® */
        .add-btn {
            position: fixed; bottom: 20px; right: 20px;
            width: 60px; height: 60px; border-radius: 50%;
            background: #1C1C1E; color: #fff; font-size: 36px;
            border: none; cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex; align-items: center; justify-content: center;
        }

        /* è®°è´¦å¼¹çª— */
        .modal {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.5); display: none;
            z-index: 100;
        }
        .modal.show { display: block; }
        .modal-content {
            position: fixed; bottom:0; left:0; right:0;
            background: #fff; border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 24px 16px;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-title {
            font-size: 20px; font-weight: 600;
            margin-bottom: 20px; text-align: center;
        }
        .amount-input {
            width: 100%; font-size: 32px; text-align: center;
            margin: 10px 0 20px; padding: 10px 0;
            border: none; border-bottom: 1px solid #E5E5EA;
            -webkit-appearance: none; appearance: none;
        }
        .amount-input:focus { outline: none; border-bottom-color: #1C1C1E; }
        .type-toggle {
            display: flex; gap: 10px; margin: 10px 0 20px;
        }
        .type-btn {
            flex: 1; padding: 12px 0;
            border-radius: 20px; border: 2px solid #E5E5EA;
            background: transparent; font-size: 16px;
            -webkit-tap-highlight-color: transparent;
        }
        .type-btn.active {
            border-color: #1C1C1E; background: #1C1C1E; color: #fff;
        }
        .category-label {
            font-size: 14px; color: #8E8E93;
            margin-bottom: 10px;
        }
        .longpress-tip {
            font-size: 12px; color: #8E8E93;
            text-align: center; margin-bottom: 10px;
        }
        .category-grid {
            display: grid; 
            grid-template-columns: repeat(4, 1fr);
            gap: 12px; margin: 10px 0 20px;
        }
        .category-item {
            display: flex; flex-direction: column;
            align-items: center;
            -webkit-tap-highlight-color: transparent;
        }
        .category-icon {
            width: 50px; height: 50px; 
            background: #F2F2F7; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; margin-bottom: 6px;
        }
        .category-item.active .category-icon {
            background: #1C1C1E; color: #fff;
        }
        .category-name {
            font-size: 12px; color: #8E8E93;
            text-align: center; /* åˆ†ç±»æ–‡å­—å±…ä¸­ */
        }
        .category-item.active .category-name {
            color: #1C1C1E; font-weight: 500;
        }
        .add-cate-btn {
            width: 100%; padding: 12px;
            border: 1px dashed #E5E5EA; border-radius: 12px;
            background: #F9F9F9; font-size: 16px;
            color: #8E8E93; margin: 10px 0 20px;
            -webkit-tap-highlight-color: transparent;
        }
        .modal-btn {
            width: 100%; padding: 14px 0;
            border-radius: 12px; border: none;
            font-size: 16px; font-weight: 500;
            margin-bottom: 10px;
            -webkit-tap-highlight-color: transparent;
        }
        .save-btn { background: #1C1C1E; color: #fff; }
        .close-btn { background: #F2F2F7; color: #1C1C1E; }

        /* æ–°å¢åˆ†ç±»å¼¹çª— */
        .add-cate-modal {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.5); display: none;
            align-items: center; justify-content: center;
            z-index: 200;
            padding: 0 20px;
        }
        .add-cate-modal.show { display: flex; }
        .add-cate-content {
            background: #fff; padding: 24px;
            border-radius: 20px; width: 100%; max-width: 300px;
        }
        .add-cate-title {
            font-size: 18px; font-weight: 600;
            margin-bottom: 15px; text-align: center;
        }
        .add-cate-input {
            width: 100%; padding: 12px;
            border: 1px solid #E5E5EA; border-radius: 12px;
            font-size: 16px; margin-bottom: 15px;
            -webkit-appearance: none; appearance: none;
        }
        .add-cate-input:focus { outline: none; border-color: #1C1C1E; }
        .add-cate-btn-group {
            display: flex; gap: 10px;
        }
        .add-cate-submit {
            flex: 1; padding: 12px;
            border-radius: 12px; border: none;
            background: #1C1C1E; color: #fff;
            font-size: 16px;
        }
        .add-cate-cancel {
            flex: 1; padding: 12px;
            border-radius: 12px; border: 1px solid #E5E5EA;
            background: transparent; font-size: 16px;
        }

        /* è‡ªå®šä¹‰æç¤ºæ¡†ï¼ˆå±…ä¸­æ˜¾ç¤ºï¼‰ */
        .custom-alert {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 300;
            display: none;
        }
        .alert-content {
            background: #000; color: #fff;
            padding: 24px; border-radius: 12px;
            width: 80%; max-width: 300px;
            text-align: center;
        }
        .alert-text {
            font-size: 16px; margin-bottom: 15px;
        }
        .alert-close {
            background: transparent;
            border: 1px solid #fff; color: #fff;
            padding: 8px 20px; border-radius: 8px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- å¯†ç é”é¡µé¢ -->
    <div class="lock-screen" id="lockScreen">
        <div class="lock-title">è¯·è¾“å…¥4ä½æ•°å­—å¯†ç </div>
        <div class="password-inputs">
            <input type="password" class="password-input" maxlength="1" oninput="nextInput(this)">
            <input type="password" class="password-input" maxlength="1" oninput="nextInput(this)">
            <input type="password" class="password-input" maxlength="1" oninput="nextInput(this)">
            <input type="password" class="password-input" maxlength="1" oninput="checkPassword()">
        </div>
    </div>

    <!-- è‡ªå®šä¹‰æç¤ºæ¡† -->
    <div class="custom-alert" id="customAlert">
        <div class="alert-content">
            <div class="alert-text" id="alertText"></div>
            <button class="alert-close" onclick="closeAlert()">å…³é—­</button>
        </div>
    </div>

    <!-- ä¸»é¡µé¢ -->
    <div id="mainPage" style="display: none;">
        <div class="main-title">å¦ä¸€ä¸ªæˆ‘</div>

        <!-- æœ¬æœˆæ”¶æ”¯ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-card">
            <div class="stats-row">
                <div class="stats-label">æœ¬æœˆæ”¯å‡º</div>
                <div class="stats-value expense" id="monthExpense">Â¥0.00</div>
            </div>
            <div class="stats-row">
                <div class="stats-label">æœ¬æœˆæ”¶å…¥</div>
                <div class="stats-value income" id="monthIncome">Â¥0.00</div>
            </div>
        </div>

        <!-- ========== iOSåŸç”Ÿé£æ ¼æ—¥å†ç»„ä»¶ ========== -->
        <div class="calendar-section">
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="calendar-nav-btn" onclick="changeMonth(-1)">â—€</button>
                    <div class="calendar-month-text" id="calendarMonthText">2025å¹´12æœˆ</div>
                    <button class="calendar-nav-btn" onclick="changeMonth(1)">â–¶</button>
                </div>
            </div>
            <div class="calendar-week">
                <div class="calendar-week-item">æ—¥</div>
                <div class="calendar-week-item">ä¸€</div>
                <div class="calendar-week-item">äºŒ</div>
                <div class="calendar-week-item">ä¸‰</div>
                <div class="calendar-week-item">å››</div>
                <div class="calendar-week-item">äº”</div>
                <div class="calendar-week-item">å…­</div>
            </div>
            <div class="calendar-days" id="calendarDays"></div>
            <div class="selected-date-tip" id="selectedDateTip">å½“å‰é€‰ä¸­ï¼š2025å¹´12æœˆ22æ—¥ï¼ˆä»Šæ—¥ï¼‰</div>
        </div>

        <!-- æœ€è¿‘è´¦å•åŒºåŸŸ -->
        <div class="bills-section">
            <div class="bills-title">å½“æ—¥è´¦å•</div>
            <div id="recentBillsList">
                <div class="bills-empty">æš‚æ— è´¦å•ï¼Œç‚¹å‡»+å¼€å§‹è®°å½•</div>
            </div>
        </div>

        <button class="add-btn" onclick="openBillModal()">+</button>

        <!-- è®°è´¦å¼¹çª— -->
        <div class="modal" id="billModal">
            <div class="modal-content">
                <div class="modal-title">è®°ä¸€ç¬”</div>
                <input type="number" class="amount-input" id="billAmount" placeholder="0.00" min="0.01" step="0.01">
                <div class="type-toggle">
                    <button class="type-btn active" onclick="setType('expense')">æ”¯å‡º</button>
                    <button class="type-btn" onclick="setType('income')">æ”¶å…¥</button>
                </div>
                
                <div class="category-label">åˆ†ç±»ï¼ˆé•¿æŒ‰åˆ é™¤ï¼‰</div>
                <div class="longpress-tip">é•¿æŒ‰åˆ†ç±»å¯åˆ é™¤</div>
                <div class="category-grid" id="categoryGrid"></div>
                
                <button class="add-cate-btn" onclick="openAddCateModal()">+ æ–°å¢åˆ†ç±»</button>
                
                <button class="modal-btn save-btn" onclick="saveBill()">ä¿å­˜</button>
                <button class="modal-btn close-btn" onclick="closeBillModal()">å…³é—­</button>
            </div>
        </div>

        <!-- æ–°å¢åˆ†ç±»å¼¹çª— -->
        <div class="add-cate-modal" id="addCateModal">
            <div class="add-cate-content">
                <div class="add-cate-title">æ–°å¢åˆ†ç±»</div>
                <input type="text" class="add-cate-input" id="newCateInput" placeholder="æ¯”å¦‚ï¼šå¥¶èŒ¶ã€è¯è´¹">
                <div class="add-cate-btn-group">
                    <button class="add-cate-submit" onclick="saveNewCate()">ç¡®è®¤</button>
                    <button class="add-cate-cancel" onclick="closeAddCateModal()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let password = '0517'; // åˆå§‹å¯†ç 0517
        let currentType = 'expense';
        let selectedCate = '';
        let longPressTimer = null;
        // åˆ†ç±»æ•°æ®
        let categories = JSON.parse(localStorage.getItem('phoneCates')) || [
            'é¤é¥®ğŸœ', 'äº¤é€šğŸšŒ', 'å¨±ä¹ğŸ¬', 'å­¦ä¹ ğŸ“š',
            'è´­ç‰©ğŸ›ï¸', 'æˆ¿ç§ŸğŸ ', 'å·¥èµ„ğŸ’¼', 'å…¶ä»–ğŸ”§'
        ];
        // åˆ†ç±»ä¸å›¾æ ‡ä¸€ä¸€å¯¹åº”æ˜ å°„è¡¨
        const cateIcons = {
            'é¤é¥®': 'ğŸœ',
            'äº¤é€š': 'ğŸšŒ',
            'å¨±ä¹': 'ğŸ¬',
            'å­¦ä¹ ': 'ğŸ“š',
            'è´­ç‰©': 'ğŸ›ï¸',
            'æˆ¿ç§Ÿ': 'ğŸ ',
            'å·¥èµ„': 'ğŸ’¼',
            'å…¶ä»–': 'ğŸ”§',
            'å¥¶èŒ¶': 'ğŸ¥¤',
            'æ¸¸æˆ': 'ğŸ®',
            'è¯è´¹': 'ğŸ“±',
            'å’–å•¡': 'â˜•',
            'ç¤¼ç‰©': 'ğŸ',
            'æ±½è½¦': 'ğŸš—',
            'ç¾å¦†': 'ğŸ’„',
            'é›¶é£Ÿ': 'ğŸ”',
            'éŸ³ä¹': 'ğŸµ'
        };
        // è´¦å•æ•°æ®
        let bills = JSON.parse(localStorage.getItem('phoneBills')) || [];
        // æ»‘åŠ¨ç›¸å…³å˜é‡ï¼ˆé€‚é…iOSåˆ é™¤æŒ‰é’®ï¼‰
        let startX = 0; 
        let currentBillId = ''; 
        // æ—¥å†ç›¸å…³å˜é‡ï¼ˆiOSé£æ ¼ï¼‰
        let currentCalendarDate = new Date(); // å½“å‰æ˜¾ç¤ºçš„æœˆä»½
        let selectedDate = new Date(); // é€‰ä¸­çš„æ—¥æœŸ

        // ========== å¯†ç é”åŠŸèƒ½ ==========
        function nextInput(input) {
            const inputs = document.querySelectorAll('.password-input');
            const index = Array.from(inputs).indexOf(input);
            if (input.value && index < 3) {
                inputs[index + 1].focus();
            }
        }
        function checkPassword() {
            const inputs = document.querySelectorAll('.password-input');
            const inputPwd = Array.from(inputs).map(i => i.value).join('');
            
            if (inputPwd.length === 4) {
                if (inputPwd === password) {
                    document.getElementById('lockScreen').style.display = 'none';
                    document.getElementById('mainPage').style.display = 'block';
                    renderCalendar(); // åˆå§‹åŒ–æ—¥å†
                    renderHomePage(); // åˆå§‹åŒ–è´¦å•
                } else {
                    document.getElementById('alertText').textContent = 'æ•°å­—å¯†ç é”™è¯¯';
                    document.getElementById('customAlert').style.display = 'flex';
                }
            }
        }
        function closeAlert() {
            document.getElementById('customAlert').style.display = 'none';
            const inputs = document.querySelectorAll('.password-input');
            inputs.forEach(input => input.value = '');
            inputs[0].focus();
        }

        // ========== iOSé£æ ¼æ—¥å†æ ¸å¿ƒåŠŸèƒ½ ==========
        // æ¸²æŸ“æ—¥å†
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            // æ›´æ–°æœˆä»½æ ‡é¢˜
            document.getElementById('calendarMonthText').textContent = `${year}å¹´${month + 1}æœˆ`;
            
            // è·å–å½“æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ ï¼ˆ0=å‘¨æ—¥ï¼‰
            const firstDay = new Date(year, month, 1).getDay();
            // è·å–å½“æœˆæ€»å¤©æ•°
            const totalDays = new Date(year, month + 1, 0).getDate();
            // è·å–ä¸Šæœˆæœ€åå‡ å¤©çš„å¤©æ•°
            const lastMonthDays = new Date(year, month, 0).getDate();

            const calendarDaysEl = document.getElementById('calendarDays');
            calendarDaysEl.innerHTML = '';

            // 1. æ¸²æŸ“ä¸Šæœˆå‰©ä½™å¤©æ•°ï¼ˆç©ºå ä½ï¼‰
            for (let i = 0; i < firstDay; i++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day empty';
                dayEl.textContent = lastMonthDays - firstDay + i + 1;
                calendarDaysEl.appendChild(dayEl);
            }

            // 2. æ¸²æŸ“å½“æœˆå¤©æ•°ï¼ˆiOSé£æ ¼ï¼‰
            const today = new Date();
            const todayYear = today.getFullYear();
            const todayMonth = today.getMonth();
            const todayDay = today.getDate();
            // è·å–æœ‰è´¦å•çš„æ—¥æœŸåˆ—è¡¨
            const billDates = getBillDates();

            for (let day = 1; day <= totalDays; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = day;

                // æ ‡è®°ä»Šæ—¥ï¼ˆiOSé£æ ¼ï¼šç°è‰²è¾¹æ¡†åœˆï¼‰
                if (year === todayYear && month === todayMonth && day === todayDay) {
                    dayEl.classList.add('today');
                }
                // æ ‡è®°æœ‰è´¦å•çš„æ—¥æœŸï¼ˆåº•éƒ¨å°çº¢ç‚¹ï¼‰
                const dateKey = `${year}-${month + 1}-${day}`;
                if (billDates.includes(dateKey)) {
                    dayEl.classList.add('has-bill');
                }
                // æ ‡è®°é€‰ä¸­æ—¥æœŸï¼ˆiOSè“è‰²èƒŒæ™¯ï¼‰
                if (year === selectedDate.getFullYear() && month === selectedDate.getMonth() && day === selectedDate.getDate()) {
                    dayEl.classList.add('active');
                }

                // ç‚¹å‡»æ—¥æœŸé€‰ä¸­
                dayEl.onclick = () => {
                    selectedDate = new Date(year, month, day);
                    // æ›´æ–°é€‰ä¸­æç¤º
                    document.getElementById('selectedDateTip').textContent = `å½“å‰é€‰ä¸­ï¼š${year}å¹´${month + 1}æœˆ${day}æ—¥`;
                    // é‡æ–°æ¸²æŸ“æ—¥å†ï¼ˆæ›´æ–°é€‰ä¸­æ€ï¼‰
                    renderCalendar();
                    // æ¸²æŸ“é€‰ä¸­æ—¥æœŸçš„è´¦å•
                    renderHomePage();
                };

                calendarDaysEl.appendChild(dayEl);
            }

            // 3. æ¸²æŸ“ä¸‹æœˆå¼€å¤´å¤©æ•°ï¼ˆç©ºå ä½ï¼‰
            const totalCells = firstDay + totalDays;
            const emptyCells = 42 - totalCells; // æ—¥å†å›ºå®š6è¡Œ42æ ¼
            for (let i = 0; i < emptyCells; i++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day empty';
                dayEl.textContent = i + 1;
                calendarDaysEl.appendChild(dayEl);
            }
        }

        // åˆ‡æ¢æœˆä»½
        function changeMonth(diff) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + diff);
            renderCalendar();
        }

        // è·å–æœ‰è´¦å•çš„æ—¥æœŸåˆ—è¡¨
        function getBillDates() {
            const dates = [];
            bills.forEach(bill => {
                const date = new Date(bill.date);
                const dateKey = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
                if (!dates.includes(dateKey)) {
                    dates.push(dateKey);
                }
            });
            return dates;
        }

        // ========== é¦–é¡µ/è´¦å•æ¸²æŸ“åŠŸèƒ½ï¼ˆé€‚é…æ—¥å†ç­›é€‰ï¼‰ ==========
        function renderHomePage() {
            // 1. è®¡ç®—é€‰ä¸­æ—¥æœŸçš„æ”¶æ”¯ï¼ˆå¦‚æœé€‰ä¸­çš„æ˜¯å½“æœˆï¼ŒåŒæ­¥æ›´æ–°æœˆåº¦ç»Ÿè®¡ï¼‰
            const selectedYear = selectedDate.getFullYear();
            const selectedMonth = selectedDate.getMonth() + 1;
            const selectedDay = selectedDate.getDate();
            
            // æœˆåº¦æ”¶æ”¯ç»Ÿè®¡ï¼ˆä»…å½“æœˆï¼‰
            const today = new Date();
            if (selectedYear === today.getFullYear() && selectedMonth === today.getMonth() + 1) {
                let monthExpense = 0;
                let monthIncome = 0;
                bills.forEach(bill => {
                    const billDate = new Date(bill.date);
                    if (billDate.getFullYear() === selectedYear && billDate.getMonth() + 1 === selectedMonth) {
                        if (bill.type === 'expense') {
                            monthExpense += parseFloat(bill.amount);
                        } else {
                            monthIncome += parseFloat(bill.amount);
                        }
                    }
                });
                document.getElementById('monthExpense').textContent = `Â¥${monthExpense.toFixed(2)}`;
                document.getElementById('monthIncome').textContent = `Â¥${monthIncome.toFixed(2)}`;
            }

            // 2. ç­›é€‰é€‰ä¸­æ—¥æœŸçš„è´¦å•
            const filteredBills = bills.filter(bill => {
                const billDate = new Date(bill.date);
                return billDate.getFullYear() === selectedYear && 
                       billDate.getMonth() + 1 === selectedMonth && 
                       billDate.getDate() === selectedDay;
            });

            const billsListEl = document.getElementById('recentBillsList');
            if (filteredBills.length === 0) {
                billsListEl.innerHTML = '<div class="bills-empty">æš‚æ— è´¦å•ï¼Œç‚¹å‡»+å¼€å§‹è®°å½•</div>';
                return;
            }

            // æ¸²æŸ“é€‰ä¸­æ—¥æœŸçš„è´¦å•
            billsListEl.innerHTML = '';
            filteredBills.forEach(bill => {
                const cate = categories.find(c => c.includes(bill.category.replace(/[^\u4e00-\u9fa5]/g, ''))) || 'å…¶ä»–ğŸ”§';
                const cateEmoji = cate.replace(/[\u4e00-\u9fa5]/g, '');
                const dateStr = bill.date.replace(/-/g, 'æœˆ') + 'æ—¥';

                // åŒ…è£¹æ»‘åŠ¨å®¹å™¨ + è´¦å•æ¡ç›® + åˆ é™¤æŒ‰é’®
                const swipeContainer = document.createElement('div');
                swipeContainer.className = 'bill-swipe-container';
                swipeContainer.setAttribute('data-bill-id', bill.id);

                // è´¦å•æ¡ç›®
                const billItem = document.createElement('div');
                billItem.className = 'bill-item';
                billItem.innerHTML = `
                    <div class="bill-left">
                        <div class="bill-icon">${cateEmoji}</div>
                        <div class="bill-info">
                            <div class="bill-category">${bill.category}</div>
                            <div class="bill-date">${dateStr}</div>
                        </div>
                    </div>
                    <div class="bill-amount ${bill.type}">
                        ${bill.type === 'expense' ? '-' : '+'}Â¥${bill.amount}
                    </div>
                `;

                // iOSåŒæ¬¾åˆ é™¤æŒ‰é’®ï¼ˆæ— æ–‡å­—ï¼Œçº¯CSSå›¾æ ‡ï¼‰
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'bill-delete-btn';
                deleteBtn.onclick = () => deleteBill(bill.id);

                // ç»‘å®šæ»‘åŠ¨äº‹ä»¶
                billItem.addEventListener('touchstart', (e) => handleTouchStart(e, bill.id));
                billItem.addEventListener('touchmove', handleTouchMove);
                billItem.addEventListener('touchend', handleTouchEnd);

                // ç»„è£…DOM
                swipeContainer.appendChild(billItem);
                swipeContainer.appendChild(deleteBtn);
                billsListEl.appendChild(swipeContainer);
            });
        }

        // ========== iOSåŒæ¬¾è´¦å•æ»‘åŠ¨äº‹ä»¶å¤„ç† ==========
        function handleTouchStart(e, billId) {
            startX = e.touches[0].clientX; 
            currentBillId = billId; 
            document.querySelectorAll('.bill-item').forEach(item => {
                item.style.left = '0px';
            });
        }
        function handleTouchMove(e) {
            if (!currentBillId) return;
            const moveX = e.touches[0].clientX;
            const diffX = startX - moveX; 
            if (diffX > 0 && diffX <= 64) {
                const billItem = document.querySelector(`.bill-swipe-container[data-bill-id="${currentBillId}"] .bill-item`);
                if (billItem) {
                    billItem.style.left = `-${diffX}px`;
                }
            }
        }
        function handleTouchEnd() {
            if (!currentBillId) return;
            const billItem = document.querySelector(`.bill-swipe-container[data-bill-id="${currentBillId}"] .bill-item`);
            const currentLeft = parseInt(billItem.style.left) || 0;
            if (Math.abs(currentLeft) >= 20) {
                billItem.style.left = '-64px'; 
            } else {
                billItem.style.left = '0px'; 
            }
            currentBillId = ''; 
        }

        // ========== åˆ é™¤è´¦å•åŠŸèƒ½ ==========
        function deleteBill(billId) {
            if (confirm('ç¡®å®šåˆ é™¤è¿™æ¡è´¦å•å—ï¼Ÿ')) {
                bills = bills.filter(bill => bill.id !== billId);
                localStorage.setItem('phoneBills', JSON.stringify(bills));
                renderCalendar(); // æ›´æ–°æ—¥å†çº¢ç‚¹
                renderHomePage();
                alert('è´¦å•åˆ é™¤æˆåŠŸï¼');
            } else {
                const billItem = document.querySelector(`.bill-swipe-container[data-bill-id="${billId}"] .bill-item`);
                if (billItem) {
                    billItem.style.left = '0px';
                }
            }
            currentBillId = '';
        }

        // ========== è®°è´¦å¼¹çª—åŠŸèƒ½ ==========
        function openBillModal() {
            renderCategories();
            document.getElementById('billModal').classList.add('show');
            setTimeout(() => {
                document.getElementById('billAmount').focus();
            }, 300);
        }
        function closeBillModal() {
            document.getElementById('billModal').classList.remove('show');
            document.getElementById('billAmount').value = '';
        }

        // ========== åˆ†ç±»åŠŸèƒ½ï¼ˆå›¾æ ‡åŒ¹é…+æ–‡å­—å±…ä¸­ï¼‰ ==========
        function renderCategories() {
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = '';
            
            categories.forEach((cate, index) => {
                const cateItem = document.createElement('div');
                cateItem.className = 'category-item';
                if (index === 0) cateItem.classList.add('active');
                
                const catePureName = cate.replace(/[^\u4e00-\u9fa5]/g, '');
                const matchIcon = cateIcons[catePureName] || 'ğŸ”§';
                
                cateItem.innerHTML = `
                    <div class="category-icon">${matchIcon}</div>
                    <div class="category-name">${catePureName}</div>
                `;

                // é•¿æŒ‰åˆ é™¤
                cateItem.addEventListener('touchstart', () => {
                    longPressTimer = setTimeout(() => {
                        if (confirm(`ç¡®å®šåˆ é™¤ã€Œ${cate}ã€åˆ†ç±»å—ï¼Ÿ`)) {
                            if (categories.length <= 1) {
                                alert('è‡³å°‘ä¿ç•™1ä¸ªåˆ†ç±»å“¦ï½');
                                return;
                            }
                            categories.splice(index, 1);
                            renderCategories();
                            localStorage.setItem('phoneCates', JSON.stringify(categories));
                            alert(`å·²åˆ é™¤ã€Œ${cate}ã€åˆ†ç±»`);
                        }
                    }, 500);
                });
                cateItem.addEventListener('touchend', () => clearTimeout(longPressTimer));
                cateItem.addEventListener('touchmove', () => clearTimeout(longPressTimer));

                // ç‚¹å‡»é€‰ä¸­
                cateItem.addEventListener('click', () => {
                    document.querySelectorAll('.category-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    cateItem.classList.add('active');
                    selectedCate = catePureName;
                });

                grid.appendChild(cateItem);
            });

            if (categories.length > 0) {
                const firstCateName = categories[0].replace(/[^\u4e00-\u9fa5]/g, '');
                selectedCate = firstCateName;
            }
            localStorage.setItem('phoneCates', JSON.stringify(categories));
        }

        // ========== æ–°å¢åˆ†ç±»åŠŸèƒ½ï¼ˆå›¾æ ‡åŒ¹é…ï¼‰ ==========
        function openAddCateModal() {
            document.getElementById('addCateModal').classList.add('show');
            document.getElementById('newCateInput').focus();
        }
        function closeAddCateModal() {
            document.getElementById('addCateModal').classList.remove('show');
            document.getElementById('newCateInput').value = '';
        }
        function saveNewCate() {
            const newCateName = document.getElementById('newCateInput').value.trim();
            if (!newCateName) {
                alert('è¯·è¾“å…¥åˆ†ç±»åç§°ï½');
                return;
            }
            const cateNames = categories.map(c => c.replace(/[^\u4e00-\u9fa5]/g, ''));
            if (cateNames.includes(newCateName)) {
                alert('è¿™ä¸ªåˆ†ç±»å·²ç»å­˜åœ¨å•¦ï½');
                return;
            }
            
            const newCateIcon = cateIcons[newCateName] || 'ğŸ”§';
            const newCate = newCateName + newCateIcon;
            
            categories.push(newCate);
            renderCategories();
            closeAddCateModal();
            alert(`æ–°å¢åˆ†ç±»æˆåŠŸï¼š${newCate}`);
        }

        // ========== æ”¶æ”¯ç±»å‹åˆ‡æ¢ ==========
        function setType(type) {
            currentType = type;
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // ========== ä¿å­˜è´¦å•åŠŸèƒ½ ==========
        function saveBill() {
            const amount = document.getElementById('billAmount').value.trim();
            if (!amount || parseFloat(amount) <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ï¼ˆå¤§äº0ï¼‰ï½');
                return;
            }
            if (!selectedCate) {
                alert('è¯·é€‰æ‹©åˆ†ç±»ï½');
                return;
            }

            const billDate = selectedDate.toISOString().split('T')[0]; // ä¿å­˜é€‰ä¸­æ—¥æœŸçš„è´¦å•
            const newBill = {
                id: Date.now().toString(),
                category: selectedCate,
                amount: parseFloat(amount).toFixed(2),
                type: currentType,
                date: billDate
            };

            bills.unshift(newBill);
            localStorage.setItem('phoneBills', JSON.stringify(bills));

            alert(`âœ… è®°è´¦æˆåŠŸï¼\n${currentType === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'}ï¼šÂ¥${amount}\nåˆ†ç±»ï¼š${selectedCate}\næ—¥æœŸï¼š${billDate.replace(/-/g, 'å¹´')}æœˆ${selectedDate.getDate()}æ—¥`);
            closeBillModal();
            renderCalendar(); // æ›´æ–°æ—¥å†çº¢ç‚¹
            renderHomePage();
        }

        // æ‰‹æœºç«¯é˜²ç¼©æ”¾
        document.addEventListener('touchmove', (e) => {
            if (e.scale !== 1) e.preventDefault();
        }, { passive: false });
    </script>
</body>
</html>
