<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å£è¢‹è´¦å•-JIAYUä¸“å±</title>
    <style>
        /* iOS 17 æ¯›ç»ç’ƒè®¾è®¡é£æ ¼ */
        :root {
            --primary-color: #007AFF;
            --primary-light: #5AC8FA;
            --bg-color: #F2F2F7;
            --card-bg: rgba(255, 255, 255, 0.85);
            --nav-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #1C1C1E;
            --text-secondary: #8E8E93;
            --text-tertiary: #C7C7CC;
            --success-color: #34C759;
            --warning-color: #FF9500;
            --danger-color: #FF3B30;
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(255, 255, 255, 0.3);
            --blur-intensity: 20px;
            --shadow-light: 0 4px 20px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "SF Pro Display", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            padding: 0;
            padding-bottom: 120px;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-color);
            z-index: -1;
        }

        /* å¯¼èˆªæ  - å»¶ä¼¸è‡³å±å¹•æœ€é¡¶éƒ¨ï¼Œä½¿ç”¨ safeAreaInsets åŠ¨æ€è®¡ç®— */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            padding-top: calc(12px + env(safe-area-inset-top)); /* åŠ¨æ€è®¡ç®—é¡¶éƒ¨å†…è¾¹è· */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            backdrop-filter: blur(var(--blur-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity));
            background: var(--bg-color); /* ä½¿ç”¨é¡µé¢ä¸»èƒŒæ™¯è‰² */
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            height: auto;
            min-height: 60px;
            transform: translateY(0);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* éšè—çŠ¶æ€ */
        .navbar.hidden {
            transform: translateY(-100%);
        }

        .navbar h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--text-primary);
            margin-top: 0;
            padding-top: 0;
        }

        .navbar-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 0;
            padding-top: 0;
        }

        /* ä¸»å†…å®¹åŒº - è°ƒæ•´é¡¶éƒ¨å†…è¾¹è· */
        .main-content {
            margin-top: calc(60px + env(safe-area-inset-top) + 20px);
            padding-top: 10px;
            transition: margin-top 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* å¯¼èˆªæ éšè—æ—¶è°ƒæ•´ä¸»å†…å®¹ */
        .navbar.hidden + .main-content {
            margin-top: 20px;
        }

        /* ä¿®æ”¹åçš„ç»Ÿè®¡å¡ç‰‡åŒºåŸŸ */
        .stats-container {
            padding: 0 20px;
            margin: 20px 0;
            height: 120px; /* è°ƒæ•´é«˜åº¦ */
            position: relative;
            overflow: hidden;
        }

        .stats-scroll {
            display: flex;
            overflow: hidden;
            gap: 8px; /* å‡å°é—´è· */
            padding: 8px 0;
            justify-content: space-between;
            width: 100%;
        }

        .stat-card {
            flex: 1;
            min-width: 0;
            max-width: calc((100% - 16px) / 3);
            width: auto;
            height: 90px; /* è°ƒæ•´é«˜åº¦ */
            background: var(--card-bg);
            border-radius: 18px;
            padding: 12px 8px; /* ç»Ÿä¸€å†…è¾¹è· */
            backdrop-filter: blur(var(--blur-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity));
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: var(--shadow-light);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:active {
            transform: scale(0.98);
        }

        .stat-card .label {
            font-size: 12px; /* ä¿æŒ12pt */
            color: #86868B; /* ä¸­ç°è‰² */
            font-weight: 500;
            margin-bottom: 8px;
            width: 100%;
            text-align: center;
        }

        .stat-card .value {
            font-size: 16px; /* è°ƒæ•´ä¸º16pt */
            font-weight: 700; /* ä¿æŒåŠ ç²— */
            letter-spacing: -0.5px;
            width: 100%;
            text-align: center;
        }

        /* æ”¶å…¥ã€ç»“ä½™è®¾ä¸ºç»¿è‰² */
        .stat-card .value.positive,
        #totalBalance.positive {
            color: var(--success-color) !important;
        }

        /* æ”¯å‡ºè®¾ä¸ºçº¢è‰² */
        .stat-card .value.negative {
            color: var(--danger-color) !important;
        }

        /* ç»“ä½™ä¸ºè´Ÿæ•°æ—¶è®¾ä¸ºçº¢è‰² */
        #totalBalance.negative {
            color: var(--danger-color) !important;
        }

        /* ä¸»å¡ç‰‡æ ·å¼ */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 24px;
            margin: 0 20px 20px;
            backdrop-filter: blur(var(--blur-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity));
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: var(--shadow-light);
            transition: transform 0.2s ease;
        }

        .card:active {
            transform: translateY(-2px);
        }

        .card h2 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-primary);
        }

        /* é¢„ç®—åœ†å½¢è¿›åº¦æ¡ */
        .budget-progress-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .budget-progress-item {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .budget-progress-circle {
            position: relative;
            width: 60px;
            height: 60px;
            flex-shrink: 0;
        }

        .budget-progress-bg {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--success-color) 0%, #E5E5EA 0%);
            position: relative;
        }

        .budget-progress-overlay {
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            background: var(--card-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 13px;
        }

        .budget-info {
            flex: 1;
        }

        .budget-info .name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .budget-info .details {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* é¢„ç®—é¡¹æ·»åŠ ä¾§æ»‘åˆ é™¤ */
        .budget-progress-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            margin: 8px 0;
            background: var(--card-bg);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .budget-progress-wrapper.swiping {
            transform: translateX(-80px);
        }

        /* é¢„ç®—åˆ é™¤æŒ‰é’® */
        .budget-delete-action {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            background: var(--danger-color); /* çŠç‘šçº¢ */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            font-weight: 600;
            font-size: 14px;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
            min-width: 80px;
            border-radius: 0 12px 12px 0;
        }

        .budget-progress-wrapper.swiping .budget-delete-action {
            transform: translateX(0);
        }

        /* åˆ—è¡¨æ ·å¼ */
        .list {
            margin-top: 10px;
        }

        .list.hidden {
            display: none;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item .info {
            flex: 1;
        }

        .list-item .name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .list-item .desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .list-item .actions {
            display: flex;
            gap: 8px;
            transition: transform 0.3s ease;
        }

        /* ç¼–è¾‘æŒ‰é’®æ ·å¼ */
        .edit-bill {
            background: var(--primary-color); /* è“è‰²èƒŒæ™¯ */
            color: white;
            border: none;
            min-width: 60px;
            text-align: center;
            opacity: 1; /* é»˜è®¤æ˜¾ç¤º */
            transition: opacity 0.3s ease, transform 0.3s ease; /* å¹³æ»‘è¿‡æ¸¡åŠ¨ç”» */
        }

        /* æ»‘åŠ¨åˆ é™¤ - æ”¹è¿›ç‰ˆï¼Œåˆ é™¤æŒ‰é’®ä¸ºçº¢è‰²èƒŒæ™¯ */
        .list-item-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            margin: 8px 0;
            background: var(--card-bg);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* å¹³æ»‘è¿‡æ¸¡åŠ¨ç”» */
        }

        /* ä¾§æ»‘æ—¶éšè—ç¼–è¾‘æŒ‰é’® */
        .list-item-wrapper.swiping .edit-bill {
            opacity: 0;
            transform: translateX(10px); /* è½»å¾®å³ç§»æ¶ˆå¤±æ•ˆæœ */
        }

        .delete-action {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            background: var(--danger-color); /* çº¢è‰²èƒŒæ™¯ */
            color: white; /* ç™½è‰²æ–‡å­— */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* å¹³æ»‘è¿‡æ¸¡åŠ¨ç”» */
            font-weight: 600;
            font-size: 14px;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
            min-width: 80px;
            border-radius: 0 12px 12px 0; /* å³ä¾§åœ†è§’ */
        }

        /* ä¾§æ»‘æ—¶æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
        .list-item-wrapper.swiping .delete-action {
            transform: translateX(0);
        }

        /* ä¾§æ»‘è¿‡ç¨‹ä¸­ */
        .list-item-wrapper.swiping {
            transform: translateX(-80px); /* å›ºå®šä¾§æ»‘è·ç¦» */
        }

        /* æŒ‰é’®æ ·å¼ - ç§»é™¤æ¸å˜è‰² */
        button {
            cursor: pointer;
            border: none;
            border-radius: 12px;
            background: var(--primary-color);
            color: white;
            padding: 12px 20px;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: -0.2px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        button:active::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(40, 40);
                opacity: 0;
            }
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(0, 122, 255, 0.2);
        }

        button:active {
            transform: scale(0.97);
        }

        button.btn-small {
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 600;
        }

        button.btn-cancel {
            background: rgba(120, 120, 128, 0.2);
            color: var(--text-primary);
            border: none;
        }

        button.btn-import {
            background: var(--primary-light);
        }

        button.btn-export {
            background: var(--success-color);
        }

        /* åº•éƒ¨å¼¹å‡ºæ¨¡æ€æ¡† */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: var(--card-bg);
            backdrop-filter: blur(var(--blur-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity));
            border-radius: 28px 28px 0 0;
            padding: 24px;
            width: 100%;
            max-width: 500px;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.28, 0, 0.24, 1);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-content h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 16px;
            border: 1.5px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-primary);
            transition: border-color 0.2s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-actions button {
            flex: 1;
        }

        /* ç©ºçŠ¶æ€ */
        .empty {
            text-align: center;
            padding: 40px 0;
            color: var(--text-tertiary);
            font-size: 15px;
        }

        .empty i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* æç¤ºæ¡† */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: white;
            padding: 14px 24px;
            border-radius: 18px;
            font-size: 15px;
            display: none;
            z-index: 1001;
            transition: transform 0.3s ease;
        }

        .toast.show {
            display: block;
            transform: translateX(-50%) translateY(0);
        }

        /* åº•éƒ¨æ·»åŠ æŒ‰é’® - iOS 26ç™½è‰²é€æ˜æ¯›ç»ç’ƒé£æ ¼ï¼Œåå­—æ¶åŠ ç²—é»‘è‰² */
        .add-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            color: #1C1C1E; /* æ”¹ä¸ºé»‘è‰² */
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.5),
                inset 0 1px 2px rgba(255, 255, 255, 0.8);
            z-index: 99;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid rgba(255, 255, 255, 0.4);
            font-weight: 800; /* åŠ ç²—åå­—æ¶ */
        }

        .add-btn:active {
            transform: scale(0.88);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 
                0 5px 15px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.6),
                inset 0 1px 2px rgba(255, 255, 255, 0.9);
        }

        .add-btn::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 255, 255, 0) 50%, 
                rgba(255, 255, 255, 0.1) 100%);
            border-radius: 50%;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .add-btn:hover::before {
            opacity: 1;
        }

        /* æ—¥æœŸç­›é€‰åŒºåŸŸ */
        .filter-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-section input[type="date"] {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1.5px solid rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        /* éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† */
        .hidden-file-input {
            display: none;
        }

        /* iPhone 17 Pro Max é€‚é… */
        @media only screen and (min-width: 430px) and (max-width: 932px) {
            body {
                max-width: 430px;
                margin: 0 auto;
                border-left: 1px solid rgba(0, 0, 0, 0.05);
                border-right: 1px solid rgba(0, 0, 0, 0.05);
            }
            
            .navbar {
                padding-left: max(20px, env(safe-area-inset-left));
                padding-right: max(20px, env(safe-area-inset-right));
                padding-top: calc(12px + env(safe-area-inset-top));
            }
            
            .stats-container, .card {
                padding-left: max(20px, env(safe-area-inset-left));
                padding-right: max(20px, env(safe-area-inset-right));
                margin-left: max(20px, env(safe-area-inset-left));
                margin-right: max(20px, env(safe-area-inset-left));
            }
            
            /* è°ƒæ•´å¡ç‰‡å†…æ•°å­—å­—å· */
            .stat-card .value {
                font-size: 18px; /* é€‚å½“å¢å¤§ */
            }
            
            .stat-card .label {
                font-size: 13px;
            }
            
            .stat-card {
                padding: 14px 10px;
                height: 100px;
            }
        }

        /* é’ˆå¯¹å°å±å¹•æ‰‹æœºçš„é¢å¤–è°ƒæ•´ */
        @media only screen and (max-width: 380px) {
            .stat-card {
                width: 110px;
                height: 95px;
                padding: 12px 6px;
            }
            
            .stat-card .value {
                font-size: 16px;
            }
            
            .stat-card .label {
                font-size: 11px;
            }
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        /* ç±»åˆ«ç®¡ç†å¡ç‰‡ */
        #categoryCard {
            display: none;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* åŒæ­¥æŒ‰é’®æ ·å¼ */
        #manualSyncBtn {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            font-size: 24px;
            z-index: 99;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        #manualSyncBtn:active {
            transform: scale(0.95);
        }
    </style>
<!-- PWA åŸºæœ¬è®¾ç½® -->
<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#007AFF">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <div class="navbar">
        <h1>è´¦å•ç®¡ç†</h1>
        <div class="navbar-actions">
            <button id="importBtn" class="btn-import btn-small">å¯¼å…¥</button>
            <button id="exportBtn" class="btn-export btn-small">å¯¼å‡º</button>
            <button id="categoryBtn" class="btn-small">åˆ†ç±»</button>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡†ç”¨äºå¯¼å…¥ -->
        <input type="file" id="importFileInput" class="hidden-file-input" accept=".json">

        <!-- ç»Ÿè®¡å¡ç‰‡ - æ¨ªå‘æ»‘åŠ¨ç»„ (å·²ç¼©å°) -->
        <div class="stats-container">
            <div class="stats-scroll" id="statsScroll">
                <div class="stat-card">
                    <div class="label">æ€»æ”¶å…¥</div>
                    <div class="value positive" id="totalIncome">0.00</div>
                </div>
                <div class="stat-card">
                    <div class="label">æ€»æ”¯å‡º</div>
                    <div class="value negative" id="totalExpense">0.00</div>
                </div>
                <div class="stat-card">
                    <div class="label">ç»“ä½™</div>
                    <div class="value" id="totalBalance">0.00</div>
                </div>
            </div>
        </div>

        <!-- ç±»åˆ«é¢„ç®—å¡ç‰‡ -->
        <div class="card">
            <h2>
                é¢„ç®—ç®¡ç†
                <button class="btn-small" id="editBudgetBtn">è®¾ç½®é¢„ç®—</button>
            </h2>
            <div id="budgetList" class="budget-progress-container">
                <div class="empty">æš‚æ— åˆ†ç±»é¢„ç®—æ•°æ®</div>
            </div>
        </div>

        <!-- æ—¥æœŸç­›é€‰ + è´¦å•åˆ—è¡¨ -->
        <div class="card">
            <h2>
                è¿‘æœŸè´¦å•
                <div class="filter-section">
                    <input type="date" id="dateFilter">
                    <button class="btn-small" id="toggleBillListBtn">æŠ˜å </button>
                </div>
            </h2>
            <div id="billList" class="list">
                <div class="empty">
                    <i>ğŸ“‹</i>
                    <div>æš‚æ— è´¦å•æ•°æ®</div>
                </div>
            </div>
        </div>

        <!-- ç±»åˆ«ç®¡ç†å¡ç‰‡ï¼ˆç‚¹å‡»å¯¼èˆªæ æŒ‰é’®æ˜¾ç¤º/éšè—ï¼‰ -->
        <div class="card" id="categoryCard" style="display: none;">
            <h2>
                åˆ†ç±»ç®¡ç†
                <button class="btn-small" id="addCategoryBtn">æ–°å¢åˆ†ç±»</button>
            </h2>
            <div id="categoryList" class="list">
                <div class="empty">æš‚æ— åˆ†ç±»æ•°æ®</div>
            </div>
        </div>

        <!-- æ·»åŠ è´¦å•æ¨¡æ€æ¡† -->
        <div class="modal" id="addBillModal">
            <div class="modal-content">
                <h3>æ·»åŠ è´¦å•</h3>
                <div class="form-group">
                    <label>ç±»å‹</label>
                    <select id="billType">
                        <option value="expense">æ”¯å‡º</option>
                        <option value="income">æ”¶å…¥</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <select id="billCategory">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </select>
                </div>
                <div class="form-group">
                    <label>é‡‘é¢ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="billAmount" step="0.01" min="0.01" placeholder="è¾“å…¥é‡‘é¢">
                </div>
                <div class="form-group">
                    <label>æ—¥æœŸ</label>
                    <input type="date" id="billDate" max="">
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨</label>
                    <input type="text" id="billNote" maxlength="50" placeholder="è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆæœ€å¤š50å­—ï¼‰">
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel" id="cancelAddBill">å–æ¶ˆ</button>
                    <button id="saveBillBtn">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘è´¦å•æ¨¡æ€æ¡† -->
        <div class="modal" id="editBillModal">
            <div class="modal-content">
                <h3>ç¼–è¾‘è´¦å•</h3>
                <input type="hidden" id="editBillId">
                <div class="form-group">
                    <label>ç±»å‹</label>
                    <select id="editBillType">
                        <option value="expense">æ”¯å‡º</option>
                        <option value="income">æ”¶å…¥</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <select id="editBillCategory">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </select>
                </div>
                <div class="form-group">
                    <label>é‡‘é¢ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="editBillAmount" step="0.01" min="0.01" placeholder="è¾“å…¥é‡‘é¢">
                </div>
                <div class="form-group">
                    <label>æ—¥æœŸ</label>
                    <input type="date" id="editBillDate" max="">
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨</label>
                    <input type="text" id="editBillNote" maxlength="50" placeholder="è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆæœ€å¤š50å­—ï¼‰">
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel" id="deleteBillBtn">åˆ é™¤</button>
                    <button class="btn-cancel" id="cancelEditBill">å–æ¶ˆ</button>
                    <button id="updateBillBtn">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- æ–°å¢ç±»åˆ«æ¨¡æ€æ¡† -->
        <div class="modal" id="addCategoryModal">
            <div class="modal-content">
                <h3>æ–°å¢åˆ†ç±»</h3>
                <div class="form-group">
                    <label>åˆ†ç±»åç§°</label>
                    <input type="text" id="newCategoryName" maxlength="10" placeholder="è¾“å…¥ç±»åˆ«åç§°">
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel" id="cancelAddCategory">å–æ¶ˆ</button>
                    <button id="saveCategoryBtn">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- è®¾ç½®ç±»åˆ«é¢„ç®—æ¨¡æ€æ¡† -->
        <div class="modal" id="setBudgetModal">
            <div class="modal-content">
                <h3>è®¾ç½®åˆ†ç±»é¢„ç®—</h3>
                <div class="form-group">
                    <label>é€‰æ‹©åˆ†ç±»</label>
                    <select id="budgetCategorySelect">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </select>
                </div>
                <div class="form-group">
                    <label>é¢„ç®—é‡‘é¢ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="budgetAmountInput" step="0.01" min="0.01" placeholder="è¾“å…¥é¢„ç®—é‡‘é¢">
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel" id="cancelSetBudget">å–æ¶ˆ</button>
                    <button id="saveBudgetBtn">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- æç¤ºæ¡† -->
        <div class="toast" id="toast"></div>

        <!-- åº•éƒ¨æ·»åŠ æŒ‰é’® (åå­—æ¶å·²æ”¹ä¸ºé»‘è‰²åŠ ç²—) -->
        <button class="add-btn" id="addBillBtn">+</button>
    </div>

    <script>
        // ========================= iCloud åŒæ­¥æ ¸å¿ƒå·¥å…· - ä¿®æ­£ç‰ˆ =========================
        const ICloudSync = {
            // æ•°æ®å­˜å‚¨é”®å
            DATA_KEY: "pocketBill_cloud_data",
            
            // æ£€æŸ¥æ˜¯å¦æ”¯æŒ iCloud - æ”¹è¿›çš„æ£€æµ‹æ–¹æ³•
            isICloudSupported() {
                // æ–¹æ³•1: æ£€æŸ¥ Safari ç‰¹å®šçš„ iCloud API
                if (window.safari && window.safari.extension && window.safari.extension.ubiquitousKeyValueStore) {
                    console.log("æ£€æµ‹åˆ° Safari iCloud API");
                    return true;
                }
                
                // æ–¹æ³•2: æ£€æŸ¥æ˜¯å¦ä¸º iOS Safari ç¯å¢ƒ
                if (this.isIOS() && this.isSafari()) {
                    console.log("æ£€æµ‹åˆ° iOS Safari ç¯å¢ƒ");
                    return true;
                }
                
                console.log("iCloud ä¸æ”¯æŒ");
                return false;
            },
            
            // æ£€æµ‹ iOS è®¾å¤‡
            isIOS() {
                return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            },
            
            // æ£€æµ‹ Safari æµè§ˆå™¨
            isSafari() {
                return /^((?!chrome|android).)*safari/i.test(navigator.userAgent) || 
                       (navigator.userAgent.includes('Mac') && 'ontouchend' in document);
            },
            
            // è·å– iCloud å­˜å‚¨å¯¹è±¡
            getCloudStore() {
                if (window.safari && window.safari.extension && window.safari.extension.ubiquitousKeyValueStore) {
                    return window.safari.extension.ubiquitousKeyValueStore;
                }
                return null;
            },
            
            // è¯»å–æ•°æ® - æ”¹è¿›ç‰ˆ
            async readData() {
                console.log("å¼€å§‹ä» iCloud è¯»å–æ•°æ®");
                
                // 1. é¦–å…ˆè¯»å–æœ¬åœ°å­˜å‚¨ä½œä¸ºé»˜è®¤å€¼
                const localData = {
                    bills: JSON.parse(localStorage.getItem(STORAGE.BILLS) || "[]"),
                    categories: JSON.parse(localStorage.getItem(STORAGE.CATEGORIES) || "[]"),
                    categoryBudgets: JSON.parse(localStorage.getItem(STORAGE.CATEGORY_BUDGETS) || "{}"),
                    timestamp: Date.now()
                };
                
                // 2. å¦‚æœä¸æ”¯æŒ iCloudï¼Œç›´æ¥è¿”å›æœ¬åœ°æ•°æ®
                if (!this.isICloudSupported()) {
                    console.log("iCloud ä¸æ”¯æŒï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®");
                    return localData;
                }
                
                const cloudStore = this.getCloudStore();
                if (!cloudStore) {
                    console.log("æœªè·å–åˆ° cloudStoreï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®");
                    return localData;
                }
                
                // 3. ä» iCloud è¯»å–æ•°æ®
                try {
                    return new Promise((resolve) => {
                        cloudStore.getItem(this.DATA_KEY, (cloudData) => {
                            console.log("ä» iCloud è¯»å–åˆ°æ•°æ®:", cloudData ? "æœ‰æ•°æ®" : "æ— æ•°æ®");
                            
                            if (cloudData) {
                                try {
                                    const parsedData = JSON.parse(cloudData);
                                    console.log("è§£æ iCloud æ•°æ®æˆåŠŸï¼Œè´¦å•æ•°é‡:", parsedData.bills ? parsedData.bills.length : 0);
                                    
                                    // åˆå¹¶æ•°æ®ï¼šä»¥ iCloud ä¸ºä¸»ï¼Œä½†ä¿ç•™æœ¬åœ°æ²¡æœ‰å†²çªçš„æ•°æ®
                                    const mergedData = {
                                        bills: this.mergeArrays(parsedData.bills || [], localData.bills),
                                        categories: this.mergeArrays(parsedData.categories || [], localData.categories),
                                        categoryBudgets: this.mergeObjects(parsedData.categoryBudgets || {}, localData.categoryBudgets),
                                        timestamp: Math.max(parsedData.timestamp || 0, localData.timestamp)
                                    };
                                    
                                    console.log("åˆå¹¶åè´¦å•æ•°é‡:", mergedData.bills.length);
                                    
                                    // ä¿å­˜åˆå¹¶åçš„æ•°æ®å›æœ¬åœ°å­˜å‚¨
                                    localStorage.setItem(STORAGE.BILLS, JSON.stringify(mergedData.bills));
                                    localStorage.setItem(STORAGE.CATEGORIES, JSON.stringify(mergedData.categories));
                                    localStorage.setItem(STORAGE.CATEGORY_BUDGETS, JSON.stringify(mergedData.categoryBudgets));
                                    
                                    resolve(mergedData);
                                } catch (error) {
                                    console.error("è§£æ iCloud æ•°æ®å¤±è´¥:", error);
                                    resolve(localData);
                                }
                            } else {
                                // iCloud æ— æ•°æ®ï¼Œå°†æœ¬åœ°æ•°æ®åŒæ­¥åˆ° iCloud
                                console.log("iCloud æ— æ•°æ®ï¼ŒåŒæ­¥æœ¬åœ°æ•°æ®åˆ°äº‘ç«¯");
                                this.writeData(localData);
                                resolve(localData);
                            }
                        });
                    });
                } catch (error) {
                    console.error("è¯»å– iCloud æ•°æ®å¼‚å¸¸:", error);
                    return localData;
                }
            },
            
            // åˆå¹¶æ•°ç»„ï¼ˆå»é‡ï¼Œä¿ç•™æœ€æ–°ï¼‰
            mergeArrays(cloudArray, localArray) {
                const merged = [...cloudArray];
                const cloudIds = new Set(cloudArray.map(item => item.id));
                
                localArray.forEach(localItem => {
                    if (!cloudIds.has(localItem.id)) {
                        merged.push(localItem);
                    }
                });
                
                return merged;
            },
            
            // åˆå¹¶å¯¹è±¡
            mergeObjects(cloudObj, localObj) {
                return { ...localObj, ...cloudObj };
            },
            
            // å†™å…¥æ•°æ® - æ”¹è¿›ç‰ˆ
            async writeData(data) {
                console.log("å¼€å§‹å†™å…¥æ•°æ®åˆ° iCloud");
                
                // 1. æ›´æ–°æœ¬åœ°å­˜å‚¨
                localStorage.setItem(STORAGE.BILLS, JSON.stringify(data.bills));
                localStorage.setItem(STORAGE.CATEGORIES, JSON.stringify(data.categories));
                localStorage.setItem(STORAGE.CATEGORY_BUDGETS, JSON.stringify(data.categoryBudgets));
                
                // 2. æ·»åŠ æ—¶é—´æˆ³ï¼Œç”¨äºå†²çªè§£å†³
                const dataWithTimestamp = {
                    ...data,
                    timestamp: Date.now(),
                    lastModified: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(dataWithTimestamp);
                
                // 3. æ”¯æŒ iCloudï¼šåŒæ­¥åˆ°äº‘ç«¯
                if (this.isICloudSupported()) {
                    const cloudStore = this.getCloudStore();
                    if (cloudStore) {
                        try {
                            cloudStore.setItem(this.DATA_KEY, dataStr, () => {
                                console.log("æ•°æ®å·²æˆåŠŸå†™å…¥ iCloud");
                            });
                        } catch (error) {
                            console.error("å†™å…¥ iCloud å¤±è´¥:", error);
                        }
                    }
                }
            },
            
            // ç›‘å¬ iCloud æ•°æ®å˜åŒ– - æ”¹è¿›ç‰ˆ
            listenCloudChange(updateCallback) {
                if (!this.isICloudSupported()) {
                    console.log("iCloud ä¸æ”¯æŒï¼Œè·³è¿‡ç›‘å¬");
                    return;
                }
                
                const cloudStore = this.getCloudStore();
                if (!cloudStore) {
                    console.log("æœªè·å–åˆ° cloudStoreï¼Œè·³è¿‡ç›‘å¬");
                    return;
                }
                
                console.log("å¼€å§‹ç›‘å¬ iCloud æ•°æ®å˜åŒ–");
                
                // ç›‘å¬ iCloud æ•°æ®å˜åŒ–
                cloudStore.addEventListener("change", (event) => {
                    console.log("iCloud æ•°æ®å˜åŒ–äº‹ä»¶:", event.key, event.newValue ? "æœ‰æ•°æ®" : "æ— æ•°æ®");
                    
                    if (event.key === this.DATA_KEY) {
                        try {
                            const newData = JSON.parse(event.newValue || '{"bills":[],"categories":[],"categoryBudgets":{}}');
                            console.log("æ¥æ”¶åˆ° iCloud æ›´æ–°ï¼Œæ—¶é—´æˆ³:", newData.timestamp);
                            
                            // åˆå¹¶æœ¬åœ°æ•°æ®
                            const localBills = JSON.parse(localStorage.getItem(STORAGE.BILLS) || "[]");
                            const localCategories = JSON.parse(localStorage.getItem(STORAGE.CATEGORIES) || "[]");
                            const localBudgets = JSON.parse(localStorage.getItem(STORAGE.CATEGORY_BUDGETS) || "{}");
                            
                            const mergedBills = this.mergeArrays(newData.bills || [], localBills);
                            const mergedCategories = this.mergeArrays(newData.categories || [], localCategories);
                            const mergedBudgets = this.mergeObjects(newData.categoryBudgets || {}, localBudgets);
                            
                            // æ›´æ–°æœ¬åœ°å­˜å‚¨
                            localStorage.setItem(STORAGE.BILLS, JSON.stringify(mergedBills));
                            localStorage.setItem(STORAGE.CATEGORIES, JSON.stringify(mergedCategories));
                            localStorage.setItem(STORAGE.CATEGORY_BUDGETS, JSON.stringify(mergedBudgets));
                            
                            // è§¦å‘å›è°ƒæ›´æ–°é¡µé¢
                            updateCallback({
                                bills: mergedBills,
                                categories: mergedCategories,
                                categoryBudgets: mergedBudgets
                            });
                            
                        } catch (error) {
                            console.error("å¤„ç† iCloud å˜åŒ–æ—¶å‡ºé”™:", error);
                        }
                    }
                });
                
                // æ·»åŠ å®šæœŸåŒæ­¥æ£€æŸ¥ï¼ˆæ¯30ç§’ï¼‰
                setInterval(async () => {
                    console.log("æ‰§è¡Œå®šæœŸåŒæ­¥æ£€æŸ¥");
                    const cloudData = await this.readData();
                    updateCallback(cloudData);
                }, 30000);
            }
        };

        // ========================= åŸæœ‰ä»£ç  =========================
        // å­˜å‚¨é”®å
        const STORAGE = {
            BILLS: 'bills',
            CATEGORIES: 'categories',
            CATEGORY_BUDGETS: 'categoryBudgets'
        };

        // æ»‘åŠ¨åˆ é™¤ç›¸å…³å˜é‡
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        let currentSwipeItem = null;

        // è·å–ä»Šå¤©æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰
        function getTodayDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // åˆå§‹åŒ–é¡µé¢ - ä¿®æ”¹ä¸ºæ”¯æŒ iCloud
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("é¡µé¢åŠ è½½ï¼Œå¼€å§‹åˆå§‹åŒ–");
            
            // åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨
            initStorage();
            
            // è®¾ç½®ä»Šæ—¥æ—¥æœŸ
            const today = getTodayDate();
            document.getElementById('billDate').value = today;
            document.getElementById('billDate').max = today;
            document.getElementById('dateFilter').value = today;
            document.getElementById('editBillDate').max = today;

            // æ­¥éª¤1ï¼šä½¿ç”¨ iCloud è¯»å–æ•°æ®å¹¶æ¸²æŸ“
            try {
                console.log("å¼€å§‹ä» iCloud è¯»å–æ•°æ®");
                const cloudData = await ICloudSync.readData();
                console.log("iCloud æ•°æ®è¯»å–å®Œæˆï¼Œè´¦å•æ•°é‡:", cloudData.bills.length);
                
                // æ›´æ–°æœ¬åœ°å­˜å‚¨
                if (cloudData.bills && cloudData.categories && cloudData.categoryBudgets) {
                    localStorage.setItem(STORAGE.BILLS, JSON.stringify(cloudData.bills));
                    localStorage.setItem(STORAGE.CATEGORIES, JSON.stringify(cloudData.categories));
                    localStorage.setItem(STORAGE.CATEGORY_BUDGETS, JSON.stringify(cloudData.categoryBudgets));
                }
            } catch (error) {
                console.error("è¯»å– iCloud æ•°æ®å¤±è´¥:", error);
            }

            // æ¸²æŸ“æ‰€æœ‰æ•°æ®
            renderCategories();
            renderCategoryBudgets();
            renderBills();
            renderStats();

            // ç»‘å®šæ‰€æœ‰äº‹ä»¶
            bindAllEvents();
            
            // åˆå§‹åŒ–æ»‘åŠ¨åˆ é™¤
            initSwipeDelete();
            
            // åˆå§‹åŒ–å¯¼èˆªæ æ»šåŠ¨éšè—/æ˜¾ç¤º
            initNavbarScroll();
            
            // åˆå§‹åŒ–é¢„ç®—ä¾§æ»‘åˆ é™¤
            if (document.getElementById('budgetList')) {
                initBudgetSwipeDelete();
            }
            
            // æ­¥éª¤3ï¼šç›‘å¬ iCloud å˜åŒ–ï¼Œè‡ªåŠ¨æ›´æ–°é¡µé¢
            ICloudSync.listenCloudChange((newData) => {
                console.log("æ¥æ”¶åˆ° iCloud æ›´æ–°å›è°ƒï¼Œè´¦å•æ•°é‡:", newData.bills.length);
                
                // æ›´æ–°é¡µé¢
                renderCategories();
                renderCategoryBudgets();
                renderBills();
                renderStats();
                
                // æ˜¾ç¤ºåŒæ­¥æç¤º
                showToast('æ•°æ®å·²ä»äº‘ç«¯æ›´æ–°');
            });
            
            // æ·»åŠ æ‰‹åŠ¨åŒæ­¥æŒ‰é’®
            const syncBtn = document.createElement('button');
            syncBtn.id = 'manualSyncBtn';
            syncBtn.textContent = 'â†»';
            syncBtn.title = 'æ‰‹åŠ¨åŒæ­¥';
            syncBtn.addEventListener('click', async () => {
                syncBtn.style.transform = 'rotate(360deg)';
                syncBtn.style.transition = 'transform 0.5s';
                
                try {
                    showToast('æ­£åœ¨åŒæ­¥...');
                    const cloudData = await ICloudSync.readData();
                    localStorage.setItem(STORAGE.BILLS, JSON.stringify(cloudData.bills));
                    localStorage.setItem(STORAGE.CATEGORIES, JSON.stringify(cloudData.categories));
                    localStorage.setItem(STORAGE.CATEGORY_BUDGETS, JSON.stringify(cloudData.categoryBudgets));
                    
                    renderCategories();
                    renderCategoryBudgets();
                    renderBills();
                    renderStats();
                    
                    showToast('æ‰‹åŠ¨åŒæ­¥æˆåŠŸ');
                } catch (error) {
                    console.error("æ‰‹åŠ¨åŒæ­¥å¤±è´¥:", error);
                    showToast('åŒæ­¥å¤±è´¥');
                }
                
                setTimeout(() => {
                    syncBtn.style.transform = 'rotate(0deg)';
                }, 500);
            });
            document.body.appendChild(syncBtn);
        });

        // åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨
        function initStorage() {
            if (!localStorage.getItem(STORAGE.BILLS)) localStorage.setItem(STORAGE.BILLS, '[]');
            if (!localStorage.getItem(STORAGE.CATEGORIES)) localStorage.setItem(STORAGE.CATEGORIES, '[]');
            if (!localStorage.getItem(STORAGE.CATEGORY_BUDGETS)) localStorage.setItem(STORAGE.CATEGORY_BUDGETS, '{}');
        }

        // ç”Ÿæˆå”¯ä¸€ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 8);
        }

        // æ˜¾ç¤ºæç¤ºæ¡†
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // è·å–æ‰€æœ‰ç±»åˆ«
        function getCategories() {
            return JSON.parse(localStorage.getItem(STORAGE.CATEGORIES) || '[]');
        }

        // è·å–æ‰€æœ‰è´¦å•
        function getBills() {
            return JSON.parse(localStorage.getItem(STORAGE.BILLS) || '[]');
        }

        // è·å–ç±»åˆ«é¢„ç®—
        function getCategoryBudgets() {
            return JSON.parse(localStorage.getItem(STORAGE.CATEGORY_BUDGETS) || '{}');
        }

        // ä¿å­˜æ‰€æœ‰æ•°æ®åˆ° iCloud
        async function saveAllDataToCloud() {
            console.log("ä¿å­˜æ‰€æœ‰æ•°æ®åˆ°äº‘ç«¯");
            const data = {
                bills: getBills(),
                categories: getCategories(),
                categoryBudgets: getCategoryBudgets()
            };
            await ICloudSync.writeData(data);
        }

        // å¯¼èˆªæ æ»šåŠ¨éšè—/æ˜¾ç¤ºåŠŸèƒ½
        function initNavbarScroll() {
            const navbar = document.querySelector('.navbar');
            const mainContent = document.querySelector('.main-content');
            let lastScrollTop = 0;
            let isScrolling = false;
            let scrollTimeout = null;
            
            let navbarVisible = true;
            
            window.addEventListener('scroll', function() {
                if (!isScrolling) {
                    window.requestAnimationFrame(function() {
                        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                        
                        if (scrollTop > lastScrollTop && scrollTop > 100) {
                            if (navbarVisible) {
                                navbar.classList.add('hidden');
                                navbarVisible = false;
                            }
                        } else if (scrollTop < lastScrollTop || scrollTop <= 100) {
                            if (!navbarVisible) {
                                navbar.classList.remove('hidden');
                                navbarVisible = true;
                            }
                        }
                        
                        lastScrollTop = scrollTop;
                        isScrolling = false;
                    });
                }
                isScrolling = true;
                
                if (scrollTimeout) {
                    clearTimeout(scrollTimeout);
                }
                
                scrollTimeout = setTimeout(function() {
                    isScrolling = false;
                }, 100);
            });
            
            mainContent.addEventListener('click', function() {
                if (!navbarVisible) {
                    navbar.classList.remove('hidden');
                    navbarVisible = true;
                }
            });
        }

        // åˆå§‹åŒ–é¢„ç®—ä¾§æ»‘åˆ é™¤åŠŸèƒ½
        function initBudgetSwipeDelete() {
            const budgetList = document.getElementById('budgetList');
            if (!budgetList) return;
            
            let touchStartX = 0;
            let touchEndX = 0;
            let currentSwipeItem = null;
            let isSwiping = false;
            
            budgetList.addEventListener('touchstart', function(e) {
                const listItem = e.target.closest('.budget-progress-wrapper');
                if (!listItem) return;
                
                touchStartX = e.touches[0].clientX;
                currentSwipeItem = listItem;
                isSwiping = false;
                
                document.querySelectorAll('.budget-progress-wrapper').forEach(item => {
                    if (item !== listItem && item.classList.contains('swiping')) {
                        item.classList.remove('swiping');
                        item.style.transform = 'translateX(0)';
                        const deleteBtn = item.querySelector('.budget-delete-action');
                        if (deleteBtn) deleteBtn.style.transform = 'translateX(100%)';
                    }
                });
            }, { passive: true });
            
            budgetList.addEventListener('touchmove', function(e) {
                if (!currentSwipeItem) return;
                
                touchEndX = e.touches[0].clientX;
                const diffX = touchStartX - touchEndX;
                
                if (Math.abs(diffX) > 5) {
                    isSwiping = true;
                    e.preventDefault();
                    
                    if (!currentSwipeItem.classList.contains('swiping')) {
                        currentSwipeItem.classList.add('swiping');
                    }
                    
                    const translateX = Math.min(diffX, 80);
                    currentSwipeItem.style.transform = `translateX(-${translateX}px)`;
                    
                    const deleteBtn = currentSwipeItem.querySelector('.budget-delete-action');
                    if (deleteBtn) {
                        const deleteTranslate = Math.max(0, translateX - 80);
                        deleteBtn.style.transform = `translateX(${deleteTranslate}px)`;
                    }
                }
            }, { passive: false });
            
            budgetList.addEventListener('touchend', function() {
                if (!currentSwipeItem) return;
                
                const diffX = touchStartX - touchEndX;
                
                if (isSwiping) {
                    if (diffX > 40) {
                        currentSwipeItem.classList.add('swiping');
                        currentSwipeItem.style.transform = 'translateX(-80px)';
                        const deleteBtn = currentSwipeItem.querySelector('.budget-delete-action');
                        if (deleteBtn) deleteBtn.style.transform = 'translateX(0)';
                    } else {
                        currentSwipeItem.classList.remove('swiping');
                        currentSwipeItem.style.transform = 'translateX(0)';
                        const deleteBtn = currentSwipeItem.querySelector('.budget-delete-action');
                        if (deleteBtn) deleteBtn.style.transform = 'translateX(100%)';
                    }
                }
                
                currentSwipeItem = null;
                isSwiping = false;
            });
            
            budgetList.addEventListener('click', function(e) {
                if (e.target.classList.contains('budget-delete-action')) {
                    e.stopPropagation();
                    const categoryId = e.target.dataset.categoryId;
                    
                    if (!confirm('ç¡®å®šåˆ é™¤è¯¥é¢„ç®—é¡¹å—ï¼Ÿ')) return;
                    
                    const budgets = getCategoryBudgets();
                    if (budgets[categoryId]) {
                        delete budgets[categoryId];
                        localStorage.setItem(STORAGE.CATEGORY_BUDGETS, JSON.stringify(budgets));
                        
                        saveAllDataToCloud();
                        
                        renderCategoryBudgets();
                        showToast('é¢„ç®—åˆ é™¤æˆåŠŸ');
                    }
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.budget-progress-wrapper') && !e.target.closest('.budget-delete-action')) {
                    document.querySelectorAll('.budget-progress-wrapper.swiping').forEach(item => {
                        item.classList.remove('swiping');
                        item.style.transform = 'translateX(0)';
                        const deleteBtn = item.querySelector('.budget-delete-action');
                        if (deleteBtn) deleteBtn.style.transform = 'translateX(100%)';
                    });
                }
            });
        }

        // å¯¼å‡ºæ‰€æœ‰æ•°æ®ä¸ºJSONæ–‡ä»¶
        async function exportData() {
            const data = {
                bills: getBills(),
                categories: getCategories(),
                categoryBudgets: getCategoryBudgets(),
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `è´¦å•æ•°æ®_${new Date().toISOString().split('T')[0]}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('æ•°æ®å¯¼å‡ºæˆåŠŸ');
        }

        // å¯¼å…¥æ•°æ®
        function importData() {
            const fileInput = document.getElementById('importFileInput');
            fileInput.click();
        }

        // å¤„ç†å¯¼å…¥çš„æ–‡ä»¶
        async function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.bills || !importedData.categories || !importedData.categoryBudgets) {
                        showToast('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                        return;
                    }

                    if (confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                        localStorage.setItem(STORAGE.BILLS, JSON.stringify(importedData.bills));
                        localStorage.setItem(STORAGE.CATEGORIES, JSON.stringify(importedData.categories));
                        localStorage.setItem(STORAGE.CATEGORY_BUDGETS, JSON.stringify(importedData.categoryBudgets));
                        
                        await saveAllDataToCloud();
                        
                        renderCategories();
                        renderCategoryBudgets();
                        renderBills();
                        renderStats();
                        
                        showToast('æ•°æ®å¯¼å…¥æˆåŠŸ');
                    }
                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    showToast('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶è§£æé”™è¯¯');
                }
                
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        // åˆå§‹åŒ–æ»‘åŠ¨åˆ é™¤åŠŸèƒ½
        function initSwipeDelete() {
            const billList = document.getElementById('billList');
            let isSwiping = false;
            
            billList.addEventListener('touchstart', function(e) {
                const listItem = e.target.closest('.list-item-wrapper');
                if (!listItem) return;
                
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                currentSwipeItem = listItem;
                isSwiping = false;
                
                document.querySelectorAll('.list-item-wrapper').forEach(item => {
                    if (item !== listItem && item.classList.contains('swiping')) {
                        item.classList.remove('swiping');
                        item.style.transform = 'translateX(0)';
                        const deleteBtn = item.querySelector('.delete-action');
                        if (deleteBtn) deleteBtn.style.transform = 'translateX(100%)';
                    }
                });
            }, { passive: true });
            
            billList.addEventListener('touchmove', function(e) {
                if (!currentSwipeItem) return;
                
                touchEndX = e.touches[0].clientX;
                touchEndY = e.touches[0].clientY;
                
                const diffX = touchStartX - touchEndX;
                const diffY = touchStartY - touchEndY;
                
                if (Math.abs(diffX) > Math.abs(diffY) && diffX > 5) {
                    isSwiping = true;
                    e.preventDefault();
                    
                    if (!currentSwipeItem.classList.contains('swiping')) {
                        currentSwipeItem.classList.add('swiping');
                    }
                    
                    const translateX = Math.min(diffX, 80);
                    currentSwipeItem.style.transform = `translateX(-${translateX}px)`;
                    
                    const deleteBtn = currentSwipeItem.querySelector('.delete-action');
                    if (deleteBtn) {
                        const deleteTranslate = Math.max(0, translateX - 80);
                        deleteBtn.style.transform = `translateX(${deleteTranslate}px)`;
                    }
                }
            }, { passive: false });
            
            billList.addEventListener('touchend', function() {
                if (!currentSwipeItem) return;
                
                const diffX = touchStartX - touchEndX;
                
                if (isSwiping) {
                    if (diffX > 40) {
                        currentSwipeItem.classList.add('swiping');
                        currentSwipeItem.style.transform = 'translateX(-80px)';
                        const deleteBtn = currentSwipeItem.querySelector('.delete-action');
                        if (deleteBtn) deleteBtn.style.transform = 'translateX(0)';
                        
                        const editBtn = currentSwipeItem.querySelector('.edit-bill');
                        if (editBtn) {
                            editBtn.style.opacity = '0';
                            editBtn.style.transform = 'translateX(10px)';
                        }
                    } else {
                        currentSwipeItem.classList.remove('swiping');
                        currentSwipeItem.style.transform = 'translateX(0)';
                        const deleteBtn = currentSwipeItem.querySelector('.delete-action');
                        if (deleteBtn) deleteBtn.style.transform = 'translateX(100%)';
                        
                        const editBtn = currentSwipeItem.querySelector('.edit-bill');
                        if (editBtn) {
                            editBtn.style.opacity = '1';
                            editBtn.style.transform = 'translateX(0)';
                        }
                    }
                }
                
                currentSwipeItem = null;
                isSwiping = false;
            });
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.list-item-wrapper') && !e.target.closest('.delete-action')) {
                    document.querySelectorAll('.list-item-wrapper.swiping').forEach(item => {
                        item.classList.remove('swiping');
                        item.style.transform = 'translateX(0)';
                        const deleteBtn = item.querySelector('.delete-action');
                        if (deleteBtn) deleteBtn.style.transform = 'translateX(100%)';
                        const editBtn = item.querySelector('.edit-bill');
                        if (editBtn) {
                            editBtn.style.opacity = '1';
                            editBtn.style.transform = 'translateX(0)';
                        }
                    });
                }
            });
        }

        // ä¿®å¤ç¼–è¾‘æŒ‰é’®äº‹ä»¶ç»‘å®šé—®é¢˜
        function bindBillEditEvents() {
            document.getElementById('billList').addEventListener('click', function(e) {
                if (e.target.classList.contains('edit-bill')) {
                    const billId = e.target.dataset.id;
                    openEditBillModal(billId);
                }
            });
        }

        // æ‰“å¼€ç¼–è¾‘è´¦å•æ¨¡æ€æ¡†
        function openEditBillModal(billId) {
            const bills = getBills();
            const categories = getCategories();
            const bill = bills.find(b => b.id === billId);
            
            if (!bill) {
                showToast('æœªæ‰¾åˆ°è¯¥è´¦å•');
                return;
            }
            
            document.getElementById('editBillId').value = bill.id;
            document.getElementById('editBillType').value = bill.type;
            document.getElementById('editBillAmount').value = bill.amount;
            document.getElementById('editBillDate').value = bill.date;
            document.getElementById('editBillNote').value = bill.note || '';
            
            const editBillCategory = document.getElementById('editBillCategory');
            editBillCategory.innerHTML = '';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                if (cat.id === bill.categoryId) {
                    option.selected = true;
                }
                editBillCategory.appendChild(option);
            });
            
            document.getElementById('editBillModal').classList.add('show');
        }

        // ç»‘å®šç¼–è¾‘è´¦å•è¡¨å•äº‹ä»¶
        function bindEditBillEvents() {
            document.getElementById('updateBillBtn').addEventListener('click', async function() {
                const billId = document.getElementById('editBillId').value;
                const type = document.getElementById('editBillType').value;
                const categoryId = document.getElementById('editBillCategory').value;
                const amount = parseFloat(document.getElementById('editBillAmount').value);
                const date = document.getElementById('editBillDate').value;
                const note = document.getElementById('editBillNote').value.trim();
                
                const today = getTodayDate();
                
                if (!categoryId) return showToast('è¯·é€‰æ‹©ç±»åˆ«');
                if (isNaN(amount) || amount < 0.01) return showToast('é‡‘é¢å¿…é¡»å¤§äº0.01å…ƒ');
                if (!date) return showToast('è¯·é€‰æ‹©æ—¥æœŸ');
                if (date > today) return showToast('ä¸èƒ½é€‰æ‹©æœªæ¥æ—¥æœŸ');
                
                const bills = getBills();
                const billIndex = bills.findIndex(b => b.id === billId);
                
                if (billIndex === -1) {
                    showToast('è´¦å•ä¸å­˜åœ¨');
                    return;
                }
                
                bills[billIndex] = {
                    ...bills[billIndex],
                    type,
                    categoryId,
                    amount,
                    date,
                    note: note || ''
                };
                
                localStorage.setItem(STORAGE.BILLS, JSON.stringify(bills));
                
                await saveAllDataToCloud();
                
                renderBills(document.getElementById('dateFilter').value);
                renderStats();
                document.getElementById('editBillModal').classList.remove('show');
                showToast('è´¦å•æ›´æ–°æˆåŠŸ');
            });
            
            document.getElementById('deleteBillBtn').addEventListener('click', async function() {
                const billId = document.getElementById('editBillId').value;
                
                if (!confirm('ç¡®å®šåˆ é™¤è¯¥è´¦å•ï¼Ÿ')) return;
                
                const bills = getBills().filter(b => b.id !== billId);
                localStorage.setItem(STORAGE.BILLS, JSON.stringify(bills));
                
                await saveAllDataToCloud();
                
                renderBills(document.getElementById('dateFilter').value);
                renderStats();
                document.getElementById('editBillModal').classList.remove('show');
                showToast('è´¦å•åˆ é™¤æˆåŠŸ');
            });
            
            document.getElementById('cancelEditBill').addEventListener('click', function() {
                document.getElementById('editBillModal').classList.remove('show');
            });
        }

        // é‡ç½®æ·»åŠ è´¦å•è¡¨å•
        function resetAddBillForm() {
            const today = getTodayDate();
            document.getElementById('billType').value = 'expense';
            document.getElementById('billAmount').value = '';
            document.getElementById('billDate').value = today;
            document.getElementById('billDate').max = today;
            document.getElementById('billNote').value = '';
            
            const categories = getCategories();
            const billCategorySelect = document.getElementById('billCategory');
            if (categories.length > 0 && billCategorySelect.options.length > 0) {
                billCategorySelect.value = categories[0].id;
            }
        }

        // é‡ç½®ç¼–è¾‘è´¦å•è¡¨å•
        function resetEditBillForm() {
            document.getElementById('editBillId').value = '';
        }

        // æ¸²æŸ“ç±»åˆ«åˆ—è¡¨
        function renderCategories() {
            const categories = getCategories();
            const categoryList = document.getElementById('categoryList');
            const billCategory = document.getElementById('billCategory');
            const editBillCategory = document.getElementById('editBillCategory');
            const budgetCategorySelect = document.getElementById('budgetCategorySelect');

            billCategory.innerHTML = '';
            editBillCategory.innerHTML = '';
            budgetCategorySelect.innerHTML = '';

            if (categories.length === 0) {
                categoryList.innerHTML = '<div class="empty">æš‚æ— ç±»åˆ«æ•°æ®</div>';
                return;
            }

            categoryList.innerHTML = '';
            categories.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="info">
                        <div class="name">${cat.name}</div>
                    </div>
                    <div class="actions">
                        <button class="btn-small edit-category" data-id="${cat.id}">ç¼–è¾‘</button>
                        <button class="btn-small delete-category" data-id="${cat.id}">åˆ é™¤</button>
                    </div>
                `;
                categoryList.appendChild(item);

                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                billCategory.appendChild(option.cloneNode(true));
                editBillCategory.appendChild(option.cloneNode(true));
                budgetCategorySelect.appendChild(option);
            });
        }

        // æ¸²æŸ“ç±»åˆ«é¢„ç®—
        function renderCategoryBudgets() {
            const budgets = getCategoryBudgets();
            const categories = getCategories();
            const budgetList = document.getElementById('budgetList');

            const budgetItems = categories.filter(cat => budgets[cat.id] && budgets[cat.id].amount > 0);

            if (budgetItems.length === 0) {
                budgetList.innerHTML = '<div class="empty">æš‚æ— åˆ†ç±»é¢„ç®—æ•°æ®</div>';
                return;
            }

            budgetList.innerHTML = '';
            budgetItems.forEach(cat => {
                const budget = budgets[cat.id];
                const used = parseFloat(budget.used || 0);
                const amount = parseFloat(budget.amount);
                const remaining = amount - used;
                const progress = Math.min(100, Math.round((used / amount) * 100));

                const wrapper = document.createElement('div');
                wrapper.className = 'budget-progress-wrapper';
                wrapper.dataset.categoryId = cat.id;
                
                wrapper.innerHTML = `
                    <div class="budget-progress-item">
                        <div class="budget-progress-circle">
                            <div class="budget-progress-bg" style="background: conic-gradient(${remaining < 0 ? '#FF3B30' : '#34C759'} 0% ${progress}%, #E5E5EA ${progress}% 100%)">
                                <div class="budget-progress-overlay">
                                    ${progress}%
                                </div>
                            </div>
                        </div>
                        <div class="budget-info">
                            <div class="name">${cat.name}</div>
                            <div class="details">
                                <span>å·²ç”¨: Â¥${used.toFixed(2)}</span>
                                <span>${remaining < 0 ? 'è¶…æ”¯: Â¥' + Math.abs(remaining).toFixed(2) : 'å‰©ä½™: Â¥' + remaining.toFixed(2)}</span>
                                <span>é¢„ç®—: Â¥${amount.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="budget-delete-action" data-category-id="${cat.id}">
                        åˆ é™¤
                    </div>
                `;
                budgetList.appendChild(wrapper);
            });
        }

        // æ¸²æŸ“è´¦å•åˆ—è¡¨
        function renderBills(filterDate = '') {
            let bills = getBills();
            const categories = getCategories();
            const billList = document.getElementById('billList');

            if (filterDate) {
                bills = bills.filter(bill => bill.date === filterDate);
            }

            if (bills.length === 0) {
                billList.innerHTML = '<div class="empty"><i>ğŸ“‹</i><div>æš‚æ— è´¦å•æ•°æ®</div></div>';
                return;
            }

            billList.innerHTML = '';
            bills.forEach(bill => {
                const cat = categories.find(c => c.id === bill.categoryId) || { name: 'æœªçŸ¥ç±»åˆ«' };
                const wrapper = document.createElement('div');
                wrapper.className = 'list-item-wrapper';
                
                const descText = bill.note ? `${bill.date} | ${bill.note}` : bill.date;
                
                wrapper.innerHTML = `
                    <div class="list-item">
                        <div class="info">
                            <div class="name">${cat.name} ${bill.type === 'income' ? '(æ”¶å…¥)' : '(æ”¯å‡º)'}</div>
                            <div class="desc">${descText}</div>
                        </div>
                        <div class="actions">
                            <span style="font-weight: 700; ${bill.type === 'income' ? 'color: #34C759' : 'color: #FF3B30'}">
                                ${bill.type === 'income' ? '+' : '-'}Â¥${bill.amount.toFixed(2)}
                            </span>
                            <button class="btn-small edit-bill" data-id="${bill.id}">ç¼–è¾‘</button>
                        </div>
                    </div>
                    <div class="delete-action" data-id="${bill.id}">
                        åˆ é™¤
                    </div>
                `;
                billList.appendChild(wrapper);
            });
            
            document.querySelectorAll('.delete-action').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const id = this.dataset.id;
                    if (!confirm('ç¡®å®šåˆ é™¤è¯¥è´¦å•ï¼Ÿ')) return;

                    const bills = getBills().filter(b => b.id !== id);
                    localStorage.setItem(STORAGE.BILLS, JSON.stringify(bills));
                    
                    await saveAllDataToCloud();

                    renderBills(document.getElementById('dateFilter').value);
                    renderStats();
                    showToast('è´¦å•åˆ é™¤æˆåŠŸ');
                });
            });
        }

        // æ¸²æŸ“ç»Ÿè®¡æ•°æ®
        function renderStats() {
            const bills = getBills();
            let income = 0, expense = 0;

            bills.forEach(bill => {
                const amount = parseFloat(bill.amount);
                if (bill.type === 'income') {
                    income += amount;
                } else {
                    expense += amount;
                }
            });

            const balance = income - expense;
            
            document.getElementById('totalIncome').textContent = income.toFixed(2);
            document.getElementById('totalExpense').textContent = expense.toFixed(2);
            document.getElementById('totalBalance').textContent = balance.toFixed(2);
            
            document.getElementById('totalBalance').className = `value ${balance >= 0 ? 'positive' : 'negative'}`;

            updateCategoryBudgetUsed();
        }

        // æ›´æ–°ç±»åˆ«é¢„ç®—çš„å·²ä½¿ç”¨é‡‘é¢
        function updateCategoryBudgetUsed() {
            const bills = getBills();
            const budgets = getCategoryBudgets();
            const categories = getCategories();

            categories.forEach(cat => {
                if (!budgets[cat.id]) budgets[cat.id] = { amount: 0, used: 0 };
                budgets[cat.id].used = 0;
            });

            bills.forEach(bill => {
                if (bill.type === 'expense' && budgets[bill.categoryId]) {
                    budgets[bill.categoryId].used += parseFloat(bill.amount);
                }
            });

            localStorage.setItem(STORAGE.CATEGORY_BUDGETS, JSON.stringify(budgets));
            renderCategoryBudgets();
        }

        // ç»‘å®šæ‰€æœ‰äº‹ä»¶
        function bindAllEvents() {
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('importBtn').addEventListener('click', importData);
            document.getElementById('importFileInput').addEventListener('change', handleImportFile);

            document.getElementById('categoryBtn').addEventListener('click', function() {
                const card = document.getElementById('categoryCard');
                card.style.display = card.style.display === 'none' ? 'block' : 'none';
            });

            document.getElementById('addBillBtn').addEventListener('click', function() {
                const categories = getCategories();
                if (categories.length === 0) {
                    showToast('è¯·å…ˆæ·»åŠ ç±»åˆ«');
                    return;
                }
                resetAddBillForm();
                document.getElementById('addBillModal').classList.add('show');
            });

            document.getElementById('cancelAddBill').addEventListener('click', function() {
                document.getElementById('addBillModal').classList.remove('show');
                resetAddBillForm();
            });

            document.getElementById('saveBillBtn').addEventListener('click', async function() {
                const type = document.getElementById('billType').value;
                const categoryId = document.getElementById('billCategory').value;
                const amount = parseFloat(document.getElementById('billAmount').value);
                const date = document.getElementById('billDate').value;
                const note = document.getElementById('billNote').value.trim();
                
                const today = getTodayDate();
                
                if (!categoryId) return showToast('è¯·é€‰æ‹©ç±»åˆ«');
                if (isNaN(amount) || amount < 0.01) return showToast('é‡‘é¢å¿…é¡»å¤§äº0.01å…ƒ');
                if (!date) return showToast('è¯·é€‰æ‹©æ—¥æœŸ');
                if (date > today) return showToast('ä¸èƒ½é€‰æ‹©æœªæ¥æ—¥æœŸ');

                const bills = getBills();
                bills.push({
                    id: generateId(),
                    type,
                    categoryId,
                    amount,
                    date,
                    note: note || ''
                });
                localStorage.setItem(STORAGE.BILLS, JSON.stringify(bills));
                
                await saveAllDataToCloud();

                renderBills(document.getElementById('dateFilter').value);
                renderStats();
                document.getElementById('addBillModal').classList.remove('show');
                resetAddBillForm();
                showToast('è´¦å•æ·»åŠ æˆåŠŸ');
            });

            document.getElementById('toggleBillListBtn').addEventListener('click', function() {
                const billList = document.getElementById('billList');
                billList.classList.toggle('hidden');
                this.textContent = billList.classList.contains('hidden') ? 'å±•å¼€' : 'æŠ˜å ';
            });

            document.getElementById('addCategoryBtn').addEventListener('click', function() {
                document.getElementById('addCategoryModal').classList.add('show');
            });

            document.getElementById('cancelAddCategory').addEventListener('click', function() {
                document.getElementById('addCategoryModal').classList.remove('show');
            });

            document.getElementById('saveCategoryBtn').addEventListener('click', async function() {
                const name = document.getElementById('newCategoryName').value.trim();
                if (!name || name.length > 10) return showToast('è¯·è¾“å…¥1-10ä¸ªå­—çš„ç±»åˆ«åç§°');

                const categories = getCategories();
                if (categories.some(c => c.name === name)) return showToast('ç±»åˆ«åç§°å·²å­˜åœ¨');

                categories.push({ id: generateId(), name });
                localStorage.setItem(STORAGE.CATEGORIES, JSON.stringify(categories));

                const budgets = getCategoryBudgets();
                budgets[categories[categories.length - 1].id] = { amount: 0, used: 0 };
                localStorage.setItem(STORAGE.CATEGORY_BUDGETS, JSON.stringify(budgets));
                
                await saveAllDataToCloud();

                renderCategories();
                document.getElementById('addCategoryModal').classList.remove('show');
                document.getElementById('newCategoryName').value = '';
                showToast('ç±»åˆ«æ·»åŠ æˆåŠŸ');
            });

            document.getElementById('categoryList').addEventListener('click', async function(e) {
                if (e.target.classList.contains('edit-category')) {
                    const id = e.target.dataset.id;
                    const categories = getCategories();
                    const cat = categories.find(c => c.id === id);
                    if (!cat) return;

                    const newName = prompt('è¯·è¾“å…¥æ–°çš„åˆ†ç±»åç§°', cat.name);
                    if (!newName || newName.trim() === '' || newName.length > 10) return;
                    if (categories.some(c => c.id !== id && c.name === newName.trim())) {
                        return showToast('ç±»åˆ«åç§°å·²å­˜åœ¨');
                    }

                    const updated = categories.map(c => c.id === id ? { ...c, name: newName.trim() } : c);
                    localStorage.setItem(STORAGE.CATEGORIES, JSON.stringify(updated));
                    
                    await saveAllDataToCloud();
                    
                    renderCategories();
                    renderCategoryBudgets();
                    showToast('åˆ†ç±»ç¼–è¾‘æˆåŠŸ');
                }

                if (e.target.classList.contains('delete-category')) {
                    const id = e.target.dataset.id;
                    if (!confirm('ç¡®å®šåˆ é™¤è¯¥ç±»åˆ«ï¼Ÿå…³è”è´¦å•å°†æ˜¾ç¤ºä¸ºæœªçŸ¥ç±»åˆ«')) return;

                    const categories = getCategories().filter(c => c.id !== id);
                    localStorage.setItem(STORAGE.CATEGORIES, JSON.stringify(categories));

                    const budgets = getCategoryBudgets();
                    delete budgets[id];
                    localStorage.setItem(STORAGE.CATEGORY_BUDGETS, JSON.stringify(budgets));
                    
                    await saveAllDataToCloud();

                    renderCategories();
                    renderCategoryBudgets();
                    showToast('åˆ†ç±»åˆ é™¤æˆåŠŸ');
                }
            });

            document.getElementById('editBudgetBtn').addEventListener('click', function() {
                const categories = getCategories();
                if (categories.length === 0) {
                    showToast('è¯·å…ˆæ·»åŠ ç±»åˆ«');
                    return;
                }
                document.getElementById('setBudgetModal').classList.add('show');
            });

            document.getElementById('cancelSetBudget').addEventListener('click', function() {
                document.getElementById('setBudgetModal').classList.remove('show');
            });

            document.getElementById('saveBudgetBtn').addEventListener('click', async function() {
                const categoryId = document.getElementById('budgetCategorySelect').value;
                const amount = parseFloat(document.getElementById('budgetAmountInput').value);

                if (!categoryId) return showToast('è¯·é€‰æ‹©ç±»åˆ«');
                if (isNaN(amount) || amount < 0.01) return showToast('é¢„ç®—é‡‘é¢å¿…é¡»å¤§äº0.01å…ƒ');

                const budgets = getCategoryBudgets();
                if (!budgets[categoryId]) budgets[categoryId] = { amount: 0, used: 0 };
                budgets[categoryId].amount = amount;
                localStorage.setItem(STORAGE.CATEGORY_BUDGETS, JSON.stringify(budgets));
                
                await saveAllDataToCloud();

                renderCategoryBudgets();
                document.getElementById('setBudgetModal').classList.remove('show');
                document.getElementById('budgetAmountInput').value = '';
                showToast('é¢„ç®—è®¾ç½®æˆåŠŸ');
            });

            document.getElementById('dateFilter').addEventListener('change', function() {
                renderBills(this.value);
            });

            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('show');
                        if (this.id === 'addBillModal') resetAddBillForm();
                        if (this.id === 'editBillModal') resetEditBillForm();
                    }
                });
            });

            bindBillEditEvents();
            bindEditBillEvents();
        }
    </script>
</body>
</html>
