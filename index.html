<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¦ä¸€ä¸ªæˆ‘ - è®°è´¦APP</title>
  <style>
    /* å…¨å±€æ ·å¼ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    body {
      background-color: #f5f5f7;
      padding-bottom: 60px;
    }
    .page {
      width: 100%;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      padding: 20px;
    }
    /* å¯†ç é”é¡µé¢ - ç¡®ä¿é»˜è®¤æ˜¾ç¤º */
    #password-page {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: #f5f5f7;
      z-index: 999; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
    }
    #password-page h2 {
      font-size: 32px;
      margin-bottom: 40px;
      color: #1d1d1f;
    }
    .password-container {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    .password-input {
      width: 50px;
      height: 50px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      text-align: center;
      font-size: 24px;
      outline: none;
      -webkit-appearance: none;
    }
    .password-input:focus {
      border-color: #007aff;
    }
    .error-tip {
      color: #ff3b30;
      font-size: 14px;
      display: none;
      margin-top: 10px;
    }
    /* ä¸»é¡µé¢ - ç¡®ä¿é»˜è®¤éšè— */
    #main-page {
      display: none;
      background-color: #f5f5f7;
      z-index: 998;
      overflow-y: auto; /* è§£å†³å†…å®¹æº¢å‡ºé—®é¢˜ */
    }
    .main-header {
      text-align: center;
      padding: 15px 0;
      font-size: 24px;
      font-weight: 600;
      color: #1d1d1f;
    }
    /* æ”¶æ”¯ç»Ÿè®¡å¡ç‰‡ */
    .stats-card {
      background-color: #fff;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .stats-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 16px;
    }
    .stats-item:last-child {
      margin-bottom: 0;
    }
    .expense {
      color: #ff3b30;
    }
    .income {
      color: #34c759;
    }
    .balance {
      color: #007aff;
      font-weight: 600;
    }
    /* é¢„ç®—åŒºåŸŸ */
    .budget-section {
      background-color: #fff;
      border-radius: 16px;
      padding: 15px 20px;
      margin-bottom: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .budget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .budget-title {
      font-size: 18px;
      font-weight: 600;
      color: #1d1d1f;
    }
    .set-budget-btn {
      font-size: 14px;
      color: #007aff;
      border: none;
      background: none;
      cursor: pointer;
    }
    .budget-list {
      max-height: 150px;
      overflow-y: auto;
    }
    .budget-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .budget-item:last-child {
      border-bottom: none;
    }
    .budget-category {
      font-size: 15px;
    }
    .budget-usage {
      font-size: 14px;
    }
    .budget-surplus {
      color: #34c759;
    }
    .budget-overspend {
      color: #ff3b30;
    }
    /* æ—¥æœŸæç¤º */
    .date-tip {
      font-size: 16px;
      margin: 10px 0;
      color: #8e8e93;
    }
    /* è´¦å•åˆ—è¡¨ */
    .bill-list {
      background-color: #fff;
      border-radius: 16px;
      padding: 10px 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }
    .bill-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      border-bottom: 1px solid #f0f0f0;
      position: relative;
      transition: transform 0.3s ease;
    }
    .bill-item:last-child {
      border-bottom: none;
    }
    .bill-category {
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .bill-amount {
      font-size: 16px;
    }
    .bill-amount.expense {
      color: #ff3b30;
    }
    .bill-amount.income {
      color: #34c759;
    }
    .bill-delete {
      position: absolute;
      right: 0;
      width: 60px;
      height: 100%;
      background-color: #ff3b30;
      border: none;
      border-radius: 0 16px 16px 0;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .bill-empty {
      text-align: center;
      padding: 30px 0;
      color: #8e8e93;
      font-size: 15px;
    }
    /* åº•éƒ¨åŠŸèƒ½æŒ‰é’® */
    .bottom-btns {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
    }
    .func-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: #007aff;
      color: #fff;
      border: none;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 10px rgba(0,122,255,0.5);
    }
    /* å¼¹çª—æ ·å¼ */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: #fff;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      padding: 20px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #f0f0f0;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }
    .close-modal {
      border: none;
      background: none;
      font-size: 20px;
      color: #8e8e93;
      cursor: pointer;
    }
    .form-item {
      margin-bottom: 15px;
    }
    .form-label {
      display: block;
      margin-bottom: 5px;
      font-size: 15px;
      color: #1d1d1f;
    }
    .form-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
    }
    .form-input:focus {
      border-color: #007aff;
    }
    .radio-group {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }
    .radio-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .category-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
      max-height: 150px;
      overflow-y: auto;
    }
    .category-item {
      padding: 8px 15px;
      border: 1px solid #e0e0e0;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
    }
    .category-item.active {
      background-color: #007aff;
      color: #fff;
      border-color: #007aff;
    }
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .confirm-btn {
      flex: 1;
      padding: 10px;
      background-color: #007aff;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    .cancel-btn {
      flex: 1;
      padding: 10px;
      background-color: #f5f5f7;
      color: #1d1d1f;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    /* æ—¥å†å¼¹çª—æ ·å¼ */
    .calendar {
      width: 100%;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .calendar-month {
      font-size: 16px;
      font-weight: 600;
    }
    .calendar-btn {
      border: none;
      background: none;
      font-size: 18px;
      color: #007aff;
      cursor: pointer;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    .calendar-day {
      text-align: center;
      padding: 8px;
      font-size: 14px;
      border-radius: 50%;
      cursor: pointer;
      position: relative;
    }
    .calendar-day.today {
      border: 2px solid #007aff;
    }
    .calendar-day.selected {
      background-color: #007aff;
      color: #fff;
    }
    .calendar-day.has-bill::after {
      content: '';
      position: absolute;
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background-color: #ff3b30;
    }
    /* é¢„ç®—è®¾ç½®å¼¹çª— */
    .budget-form-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .budget-form-label {
      font-size: 15px;
    }
    .budget-form-input {
      width: 100px;
      padding: 5px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      text-align: right;
    }
  </style>
</head>
<body>
  <!-- å¯†ç é”é¡µé¢ -->
  <div id="password-page" class="page">
    <h2>å¦ä¸€ä¸ªæˆ‘</h2>
    <div class="password-container">
      <input type="tel" class="password-input" maxlength="1" placeholder="*" data-index="0">
      <input type="tel" class="password-input" maxlength="1" placeholder="*" data-index="1">
      <input type="tel" class="password-input" maxlength="1" placeholder="*" data-index="2">
      <input type="tel" class="password-input" maxlength="1" placeholder="*" data-index="3">
    </div>
    <div class="error-tip">å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥</div>
  </div>

  <!-- ä¸»é¡µé¢ -->
  <div id="main-page" class="page">
    <div class="main-header">å¦ä¸€ä¸ªæˆ‘</div>
    
    <!-- æ”¶æ”¯ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-card">
      <div class="stats-item">
        <span>æœ¬æœˆæ”¯å‡º</span>
        <span class="expense" id="monthly-expense">Â¥0.00</span>
      </div>
      <div class="stats-item">
        <span>æœ¬æœˆæ”¶å…¥</span>
        <span class="income" id="monthly-income">Â¥0.00</span>
      </div>
      <div class="stats-item">
        <span>è´¦æˆ·ä½™é¢</span>
        <span class="balance" id="account-balance">Â¥0.00</span>
      </div>
    </div>

    <!-- é¢„ç®—åŒºåŸŸ -->
    <div class="budget-section">
      <div class="budget-header">
        <span class="budget-title">æœ¬æœˆåˆ†ç±»é¢„ç®—</span>
        <button class="set-budget-btn" id="set-budget-btn">è®¾ç½®é¢„ç®—</button>
      </div>
      <div class="budget-list" id="budget-list">
        <div style="text-align:center; padding:10px; color:#8e8e93;">æš‚æ— é¢„ç®—è®¾ç½®</div>
      </div>
    </div>

    <!-- æ—¥æœŸæç¤º -->
    <div class="date-tip" id="current-date-tip">å½“å‰é€‰ä¸­ï¼š2025-12-22</div>

    <!-- è´¦å•åˆ—è¡¨ -->
    <div class="bill-list" id="bill-list">
      <div class="bill-empty">æš‚æ— è´¦å•ï¼Œç‚¹å‡»+å¼€å§‹è®°å½•</div>
    </div>

    <!-- åº•éƒ¨åŠŸèƒ½æŒ‰é’® -->
    <div class="bottom-btns">
      <button class="func-btn" id="add-bill-btn">+</button>
      <button class="func-btn" id="calendar-btn">æ—¥</button>
    </div>
  </div>

  <!-- è®°è´¦å¼¹çª— -->
  <div class="modal" id="bill-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">æ–°å¢è´¦å•</h3>
        <button class="close-modal" data-modal="bill-modal">Ã—</button>
      </div>
      <div class="radio-group">
        <label class="radio-item">
          <input type="radio" name="bill-type" value="expense" checked> æ”¯å‡º
        </label>
        <label class="radio-item">
          <input type="radio" name="bill-type" value="income"> æ”¶å…¥
        </label>
      </div>
      <div class="form-item">
        <label class="form-label">é‡‘é¢ï¼ˆå…ƒï¼‰</label>
        <input type="number" class="form-input" id="bill-amount" min="0.01" step="0.01" placeholder="è¯·è¾“å…¥é‡‘é¢">
      </div>
      <div class="form-item">
        <label class="form-label">åˆ†ç±»</label>
        <div class="category-list" id="bill-category-list">
          <!-- åˆ†ç±»åˆ—è¡¨åŠ¨æ€ç”Ÿæˆ -->
        </div>
        <button class="confirm-btn" style="margin-top: 10px;" id="add-category-btn">æ–°å¢åˆ†ç±»</button>
      </div>
      <div class="btn-group">
        <button class="confirm-btn" id="save-bill-btn">ä¿å­˜</button>
        <button class="cancel-btn" data-modal="bill-modal">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- æ–°å¢åˆ†ç±»å¼¹çª— -->
  <div class="modal" id="category-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">æ–°å¢åˆ†ç±»</h3>
        <button class="close-modal" data-modal="category-modal">Ã—</button>
      </div>
      <div class="form-item">
        <label class="form-label">åˆ†ç±»åç§°</label>
        <input type="text" class="form-input" id="category-name" placeholder="è¯·è¾“å…¥åˆ†ç±»åç§°ï¼ˆå¦‚ï¼šè´­ç‰©ï¼‰">
      </div>
      <div class="btn-group">
        <button class="confirm-btn" id="save-category-btn">ä¿å­˜</button>
        <button class="cancel-btn" data-modal="category-modal">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- é¢„ç®—è®¾ç½®å¼¹çª— -->
  <div class="modal" id="budget-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">è®¾ç½®åˆ†ç±»é¢„ç®—</h3>
        <button class="close-modal" data-modal="budget-modal">Ã—</button>
      </div>
      <div id="budget-form-list">
        <!-- é¢„ç®—è¡¨å•åŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div class="btn-group">
        <button class="confirm-btn" id="save-budget-btn">ä¿å­˜é¢„ç®—</button>
        <button class="cancel-btn" data-modal="budget-modal">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- æ—¥å†å¼¹çª— -->
  <div class="modal" id="calendar-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">é€‰æ‹©æ—¥æœŸ</h3>
        <button class="close-modal" data-modal="calendar-modal">Ã—</button>
      </div>
      <div class="calendar">
        <div class="calendar-header">
          <button class="calendar-btn" id="prev-month-btn">â†</button>
          <span class="calendar-month" id="current-calendar-month">2025å¹´12æœˆ</span>
          <button class="calendar-btn" id="next-month-btn">â†’</button>
        </div>
        <div class="calendar-grid" id="calendar-grid">
          <!-- æ—¥å†ç½‘æ ¼åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // æ ¸å¿ƒé…ç½®
    const DEFAULT_PASSWORD = '0517';
    const DEFAULT_CATEGORIES = [
      { name: 'é¤é¥®', icon: 'ğŸœ' },
      { name: 'äº¤é€š', icon: 'ğŸšŒ' },
      { name: 'å¨±ä¹', icon: 'ğŸ¬' },
      { name: 'è´­ç‰©', icon: 'ğŸ›’' },
      { name: 'ä½æˆ¿', icon: 'ğŸ ' },
      { name: 'æ°´ç”µ', icon: 'ğŸ’§' },
      { name: 'é€šè®¯', icon: 'ğŸ“±' },
      { name: 'åŒ»ç–—', icon: 'ğŸ’Š' },
      { name: 'å­¦ä¹ ', icon: 'ğŸ“š' },
      { name: 'ç¤¼ç‰©', icon: 'ğŸ' },
      { name: 'å¥èº«', icon: 'ğŸ‹ï¸' },
      { name: 'ç¾å¦†', icon: 'ğŸ’„' },
      { name: 'å® ç‰©', icon: 'ğŸ±' },
      { name: 'æ—…è¡Œ', icon: 'âœˆï¸' },
      { name: 'é›¶é£Ÿ', icon: 'ğŸŸ' },
      { name: 'çƒŸé…’', icon: 'ğŸº' },
      { name: 'ä¹¦ç±', icon: 'ğŸ“–' },
      { name: 'æ•°ç ', icon: 'ğŸ“±' },
      { name: 'å…¶ä»–', icon: 'ğŸ”§' }
    ];

    // DOMå…ƒç´  - æå‰ç¼“å­˜ï¼Œç¡®ä¿è·å–æˆåŠŸ
    const passwordInputs = document.querySelectorAll('.password-input');
    const passwordPage = document.getElementById('password-page');
    const mainPage = document.getElementById('main-page');
    const errorTip = document.querySelector('.error-tip');
    
    // å…¨å±€çŠ¶æ€
    let currentDate = new Date();
    let selectedCategory = '';
    let currentCalendarMonth = new Date();

    // é¡µé¢åŠ è½½å®Œæˆåç«‹å³æ‰§è¡Œåˆå§‹åŒ–
    window.onload = function() {
      // å¼ºåˆ¶èšç„¦ç¬¬ä¸€ä¸ªå¯†ç æ¡†
      passwordInputs[0].focus();
      // åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨
      initLocalStorage();
      // ç»‘å®šå¯†ç è¾“å…¥äº‹ä»¶ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
      bindPasswordEvents();
      // åˆå§‹åŒ–ä¸»é¡µé¢å…¶ä»–åŠŸèƒ½
      initMainPage();
      initModalEvents();
      initCalendar();
      updatePageData();
    };

    // åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨
    function initLocalStorage() {
      if (!localStorage.getItem('phoneCates')) {
        localStorage.setItem('phoneCates', JSON.stringify(DEFAULT_CATEGORIES));
      }
      if (!localStorage.getItem('phoneBills')) {
        localStorage.setItem('phoneBills', JSON.stringify([]));
      }
      if (!localStorage.getItem('monthlyBudgets')) {
        localStorage.setItem('monthlyBudgets', JSON.stringify({}));
      }
    }

    // æ ¸å¿ƒä¿®å¤ï¼šç»‘å®šå¯†ç è¾“å…¥äº‹ä»¶ï¼ˆç®€åŒ–é€»è¾‘ï¼Œç¡®ä¿è§¦å‘ï¼‰
    function bindPasswordEvents() {
      // ç»™æ¯ä¸ªè¾“å…¥æ¡†ç»‘å®šè¾“å…¥äº‹ä»¶
      passwordInputs.forEach((input, index) => {
        // è¾“å…¥äº‹ä»¶ï¼šè¿‡æ»¤éæ•°å­— + è‡ªåŠ¨è·³æ ¼ + éªŒè¯
        input.addEventListener('input', function() {
          // åªä¿ç•™æ•°å­—ï¼Œæœ€å¤š1ä½
          this.value = this.value.replace(/\D/g, '').slice(0, 1);
          
          // è¾“å…¥å®Œæˆåè‡ªåŠ¨è·³æ ¼
          if (this.value && index < 3) {
            passwordInputs[index + 1].focus();
          }

          // æ£€æŸ¥æ˜¯å¦å¡«å®Œ4ä½ï¼Œç«‹å³éªŒè¯
          checkPasswordImmediately();
        });

        // é”®ç›˜äº‹ä»¶ï¼šå…¼å®¹æ‰‹åŠ¨è¾“å…¥/ç²˜è´´
        input.addEventListener('keydown', function(e) {
          // å…è®¸é€€æ ¼é”®æ¸…ç©º
          if (e.key === 'Backspace' && this.value === '' && index > 0) {
            passwordInputs[index - 1].focus();
          }
          // é˜»æ­¢éæ•°å­—é”®è¾“å…¥ï¼ˆé™¤äº†é€€æ ¼ã€Tabï¼‰
          if (!/^\d$/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Tab') {
            e.preventDefault();
          }
        });
      });

      // ç›‘å¬æ‰€æœ‰å¯†ç æ¡†çš„å¤±å»ç„¦ç‚¹äº‹ä»¶ï¼Œå…œåº•éªŒè¯
      passwordInputs.forEach(input => {
        input.addEventListener('blur', checkPasswordImmediately);
      });
    }

    // ç«‹å³éªŒè¯å¯†ç ï¼ˆæ ¸å¿ƒå‡½æ•°ï¼‰
    function checkPasswordImmediately() {
      // æ‹¼æ¥4ä½å¯†ç ï¼ˆç¡®ä¿æ¯ä¸ªè¾“å…¥æ¡†çš„å€¼éƒ½è¢«æ­£ç¡®è·å–ï¼‰
      let inputPwd = '';
      passwordInputs.forEach(input => {
        inputPwd += input.value || '';
      });

      // åªæœ‰4ä½éƒ½å¡«å®Œæ‰éªŒè¯
      if (inputPwd.length !== 4) {
        errorTip.style.display = 'none';
        return;
      }

      // å¯†ç æ­£ç¡®ï¼šå¼ºåˆ¶åˆ‡æ¢é¡µé¢
      if (inputPwd === DEFAULT_PASSWORD) {
        errorTip.style.display = 'none';
        // å¼ºåˆ¶éšè—å¯†ç é¡µï¼Œæ˜¾ç¤ºä¸»é¡µï¼ˆå¢åŠ å»¶è¿Ÿç¡®ä¿ç”Ÿæ•ˆï¼‰
        setTimeout(() => {
          passwordPage.style.display = 'none';
          mainPage.style.display = 'block';
          // æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œé¿å…å†…å®¹åç§»
          mainPage.scrollTop = 0;
        }, 10);
      } else {
        // å¯†ç é”™è¯¯ï¼šæç¤º + æ¸…ç©º
        errorTip.style.display = 'block';
        setTimeout(() => {
          clearAllPassword();
          errorTip.style.display = 'none';
        }, 1500);
      }
    }

    // æ¸…ç©ºæ‰€æœ‰å¯†ç è¾“å…¥æ¡†
    function clearAllPassword() {
      passwordInputs.forEach((input, index) => {
        input.value = '';
        if (index === 0) input.focus();
      });
    }

    // åˆå§‹åŒ–ä¸»é¡µé¢
    function initMainPage() {
      renderCategoryList();
      renderBudgetList();
      
      // ç»‘å®šæŒ‰é’®äº‹ä»¶
      document.getElementById('add-bill-btn').addEventListener('click', () => openModal('bill-modal'));
      document.getElementById('calendar-btn').addEventListener('click', () => {
        openModal('calendar-modal');
        renderCalendar(currentCalendarMonth);
      });
      document.getElementById('set-budget-btn').addEventListener('click', () => {
        openModal('budget-modal');
        renderBudgetForm();
      });
      document.getElementById('add-category-btn').addEventListener('click', () => openModal('category-modal'));
      document.getElementById('save-bill-btn').addEventListener('click', saveBill);
      document.getElementById('save-category-btn').addEventListener('click', saveCategory);
      document.getElementById('save-budget-btn').addEventListener('click', saveBudget);
    }

    // åˆå§‹åŒ–å¼¹çª—äº‹ä»¶
    function initModalEvents() {
      document.querySelectorAll('.close-modal, .cancel-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const modalId = btn.getAttribute('data-modal');
          closeModal(modalId);
        });
      });

      document.getElementById('prev-month-btn').addEventListener('click', () => {
        currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() - 1);
        renderCalendar(currentCalendarMonth);
      });
      document.getElementById('next-month-btn').addEventListener('click', () => {
        currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + 1);
        renderCalendar(currentCalendarMonth);
      });
    }

    // å¼¹çª—æ“ä½œ
    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
    }
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    // æ¸²æŸ“åˆ†ç±»åˆ—è¡¨
    function renderCategoryList() {
      const categories = JSON.parse(localStorage.getItem('phoneCates'));
      const categoryList = document.getElementById('bill-category-list');
      categoryList.innerHTML = '';
      
      categories.forEach(category => {
        const item = document.createElement('div');
        item.className = 'category-item';
        item.dataset.name = category.name;
        item.innerHTML = `${category.icon} ${category.name}`;
        item.addEventListener('click', () => {
          document.querySelectorAll('.category-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');
          selectedCategory = category.name;
        });
        categoryList.appendChild(item);

        // é•¿æŒ‰åˆ é™¤åˆ†ç±»
        let longPressTimer;
        item.addEventListener('touchstart', () => {
          longPressTimer = setTimeout(() => {
            if (confirm(`ç¡®å®šåˆ é™¤åˆ†ç±»ã€${category.name}ã€‘å—ï¼Ÿ`)) {
              deleteCategory(category.name);
            }
          }, 800);
        });
        item.addEventListener('touchend', () => clearTimeout(longPressTimer));
        item.addEventListener('mousedown', () => {
          longPressTimer = setTimeout(() => {
            if (confirm(`ç¡®å®šåˆ é™¤åˆ†ç±»ã€${category.name}ã€‘å—ï¼Ÿ`)) {
              deleteCategory(category.name);
            }
          }, 800);
        });
        item.addEventListener('mouseup', () => clearTimeout(longPressTimer));
      });

      // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
      if (categories.length > 0) {
        categoryList.firstChild.classList.add('active');
        selectedCategory = categories[0].name;
      }
    }

    // åˆ é™¤åˆ†ç±»
    function deleteCategory(categoryName) {
      let categories = JSON.parse(localStorage.getItem('phoneCates'));
      categories = categories.filter(c => c.name !== categoryName);
      localStorage.setItem('phoneCates', JSON.stringify(categories));
      renderCategoryList();
      renderBudgetForm();
    }

    // ä¿å­˜åˆ†ç±»
    function saveCategory() {
      const categoryName = document.getElementById('category-name').value.trim();
      if (!categoryName) {
        alert('è¯·è¾“å…¥åˆ†ç±»åç§°ï¼');
        return;
      }
      
      const categories = JSON.parse(localStorage.getItem('phoneCates'));
      if (categories.some(c => c.name === categoryName)) {
        alert('è¯¥åˆ†ç±»å·²å­˜åœ¨ï¼');
        return;
      }
      
      categories.push({ name: categoryName, icon: 'ğŸ”¹' });
      localStorage.setItem('phoneCates', JSON.stringify(categories));
      renderCategoryList();
      closeModal('category-modal');
      document.getElementById('category-name').value = '';
    }

    // ä¿å­˜è´¦å•
    function saveBill() {
      const amount = parseFloat(document.getElementById('bill-amount').value);
      const billType = document.querySelector('input[name="bill-type"]:checked').value;
      
      if (isNaN(amount) || amount <= 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ï¼ˆæœ€å°0.01å…ƒï¼‰ï¼');
        return;
      }
      if (!selectedCategory) {
        alert('è¯·é€‰æ‹©åˆ†ç±»ï¼');
        return;
      }
      
      const bills = JSON.parse(localStorage.getItem('phoneBills'));
      const bill = {
        id: Date.now(),
        type: billType,
        amount: amount,
        category: selectedCategory,
        date: formatDate(currentDate),
        time: new Date().toLocaleTimeString()
      };
      
      bills.unshift(bill);
      localStorage.setItem('phoneBills', JSON.stringify(bills));
      updatePageData();
      closeModal('bill-modal');
      document.getElementById('bill-amount').value = '';
    }

    // æ¸²æŸ“é¢„ç®—åˆ—è¡¨
    function renderBudgetList() {
      const budgets = JSON.parse(localStorage.getItem('monthlyBudgets'));
      const budgetList = document.getElementById('budget-list');
      const currentMonthKey = getMonthKey(currentDate);
      const monthBudgets = budgets[currentMonthKey] || {};
      const categories = JSON.parse(localStorage.getItem('phoneCates'));
      
      budgetList.innerHTML = '';
      
      const bills = JSON.parse(localStorage.getItem('phoneBills'));
      const monthBills = bills.filter(b => b.date.startsWith(getMonthKey(currentDate)));
      
      let hasBudget = false;
      for (const [category, budget] of Object.entries(monthBudgets)) {
        if (budget <= 0) continue;
        hasBudget = true;
        
        const usedAmount = monthBills
          .filter(b => b.category === category && b.type === 'expense')
          .reduce((sum, b) => sum + b.amount, 0);
        const surplus = budget - usedAmount;
        
        const item = document.createElement('div');
        item.className = 'budget-item';
        item.innerHTML = `
          <div class="budget-category">${categories.find(c => c.name === category)?.icon || 'ğŸ”¹'} ${category}</div>
          <div class="budget-usage">
            Â¥${usedAmount.toFixed(2)}/${budget.toFixed(2)} 
            <span class="${surplus >= 0 ? 'budget-surplus' : 'budget-overspend'}">
              ${surplus >= 0 ? 'å‰©ä½™' : 'è¶…æ”¯'} Â¥${Math.abs(surplus).toFixed(2)}
            </span>
          </div>
        `;
        budgetList.appendChild(item);
      }
      
      if (!hasBudget) {
        budgetList.innerHTML = '<div style="text-align:center; padding:10px; color:#8e8e93;">æš‚æ— é¢„ç®—è®¾ç½®</div>';
      }
    }

    // æ¸²æŸ“é¢„ç®—è¡¨å•
    function renderBudgetForm() {
      const categories = JSON.parse(localStorage.getItem('phoneCates'));
      const budgets = JSON.parse(localStorage.getItem('monthlyBudgets'));
      const currentMonthKey = getMonthKey(currentDate);
      const monthBudgets = budgets[currentMonthKey] || {};
      const budgetFormList = document.getElementById('budget-form-list');
      
      budgetFormList.innerHTML = '';
      
      categories.forEach(category => {
        const item = document.createElement('div');
        item.className = 'budget-form-item';
        item.innerHTML = `
          <label class="budget-form-label">${category.icon} ${category.name}</label>
          <input type="number" class="budget-form-input" data-category="${category.name}" 
                 min="0.01" step="0.01" value="${monthBudgets[category.name] || ''}" 
                 placeholder="è¾“å…¥é¢„ç®—é‡‘é¢">
        `;
        budgetFormList.appendChild(item);
      });
    }

    // ä¿å­˜é¢„ç®—
    function saveBudget() {
      const budgets = JSON.parse(localStorage.getItem('monthlyBudgets'));
      const currentMonthKey = getMonthKey(currentDate);
      const monthBudgets = {};
      
      document.querySelectorAll('.budget-form-input').forEach(input => {
        const category = input.dataset.category;
        const amount = parseFloat(input.value);
        if (!isNaN(amount) && amount > 0) {
          monthBudgets[category] = amount;
        }
      });
      
      budgets[currentMonthKey] = monthBudgets;
      localStorage.setItem('monthlyBudgets', JSON.stringify(budgets));
      renderBudgetList();
      closeModal('budget-modal');
    }

    // åˆå§‹åŒ–æ—¥å†
    function initCalendar() {
      renderCalendar(currentCalendarMonth);
    }

    // æ¸²æŸ“æ—¥å†
    function renderCalendar(date) {
      const year = date.getFullYear();
      const month = date.getMonth();
      document.getElementById('current-calendar-month').textContent = `${year}å¹´${month + 1}æœˆ`;
      
      const calendarGrid = document.getElementById('calendar-grid');
      calendarGrid.innerHTML = '';
      
      // æ˜ŸæœŸæ ‡é¢˜
      const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
      weekdays.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day';
        header.style.fontWeight = '600';
        header.textContent = day;
        calendarGrid.appendChild(header);
      });
      
      // å½“æœˆç¬¬ä¸€å¤©/æœ€åä¸€å¤©
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const firstDayWeek = firstDay.getDay();
      
      // å¡«å……å‰é¢çš„ç©ºç™½
      for (let i = 0; i < firstDayWeek; i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day';
        calendarGrid.appendChild(empty);
      }
      
      // æ ‡è®°æœ‰è´¦å•çš„æ—¥æœŸ
      const bills = JSON.parse(localStorage.getItem('phoneBills'));
      const billDates = new Set();
      bills.forEach(bill => {
        if (bill.date.startsWith(`${year}-${String(month + 1).padStart(2, '0')}`)) {
          billDates.add(bill.date.split(' ')[0].split('-')[2]);
        }
      });
      
      // å¡«å……æ—¥æœŸ
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const dateItem = document.createElement('div');
        dateItem.className = 'calendar-day';
        dateItem.textContent = day;
        dateItem.dataset.date = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        // æ ‡è®°ä»Šæ—¥
        const today = new Date();
        if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
          dateItem.classList.add('today');
        }
        
        // æ ‡è®°é€‰ä¸­æ—¥æœŸ
        const selectedDateStr = formatDate(currentDate).split(' ')[0];
        if (dateItem.dataset.date === selectedDateStr) {
          dateItem.classList.add('selected');
        }
        
        // æ ‡è®°æœ‰è´¦å•
        if (billDates.has(String(day).padStart(2, '0'))) {
          dateItem.classList.add('has-bill');
        }
        
        // ç‚¹å‡»é€‰æ‹©æ—¥æœŸ
        dateItem.addEventListener('click', () => {
          currentDate = new Date(dateItem.dataset.date);
          document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
          dateItem.classList.add('selected');
          updatePageData();
          closeModal('calendar-modal');
        });
        
        calendarGrid.appendChild(dateItem);
      }
    }

    // æ›´æ–°é¡µé¢æ•°æ®
    function updatePageData() {
      document.getElementById('current-date-tip').textContent = `å½“å‰é€‰ä¸­ï¼š${formatDate(currentDate)}`;
      updateStats();
      renderBillList();
      renderBudgetList();
    }

    // æ›´æ–°æ”¶æ”¯ç»Ÿè®¡
    function updateStats() {
      const bills = JSON.parse(localStorage.getItem('phoneBills'));
      const currentMonth = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
      
      let monthlyExpense = 0;
      let monthlyIncome = 0;
      
      bills.forEach(bill => {
        if (bill.date.startsWith(currentMonth)) {
          if (bill.type === 'expense') {
            monthlyExpense += bill.amount;
          } else {
            monthlyIncome += bill.amount;
          }
        }
      });
      
      document.getElementById('monthly-expense').textContent = `Â¥${monthlyExpense.toFixed(2)}`;
      document.getElementById('monthly-income').textContent = `Â¥${monthlyIncome.toFixed(2)}`;
      document.getElementById('account-balance').textContent = `Â¥${(monthlyIncome - monthlyExpense).toFixed(2)}`;
    }

    // æ¸²æŸ“è´¦å•åˆ—è¡¨
    function renderBillList() {
      const bills = JSON.parse(localStorage.getItem('phoneBills'));
      const billList = document.getElementById('bill-list');
      const targetDate = formatDate(currentDate).split(' ')[0];
      
      const dayBills = bills.filter(bill => bill.date.startsWith(targetDate));
      
      billList.innerHTML = '';
      
      if (dayBills.length === 0) {
        billList.innerHTML = '<div class="bill-empty">æš‚æ— è´¦å•ï¼Œç‚¹å‡»+å¼€å§‹è®°å½•</div>';
        return;
      }
      
      dayBills.forEach(bill => {
        const billItem = document.createElement('div');
        billItem.className = 'bill-item';
        billItem.dataset.id = bill.id;
        
        const categories = JSON.parse(localStorage.getItem('phoneCates'));
        const categoryIcon = categories.find(c => c.name === bill.category)?.icon || 'ğŸ”¹';
        
        billItem.innerHTML = `
          <div class="bill-category">${categoryIcon} ${bill.category}</div>
          <div class="bill-amount ${bill.type}">${bill.type === 'expense' ? '-' : '+'}Â¥${bill.amount.toFixed(2)}</div>
          <button class="bill-delete" style="display:none;">Ã—</button>
        `;
        
        // å·¦æ»‘åˆ é™¤
        let startX = 0;
        let isSliding = false;
        
        billItem.addEventListener('touchstart', (e) => {
          startX = e.touches[0].clientX;
        });
        
        billItem.addEventListener('touchmove', (e) => {
          const moveX = e.touches[0].clientX;
          const diffX = startX - moveX;
          if (diffX > 0) {
            e.preventDefault();
            const translateX = Math.min(diffX, 60);
            billItem.style.transform = `translateX(-${translateX}px)`;
            billItem.querySelector('.bill-delete').style.display = translateX > 30 ? 'flex' : 'none';
            isSliding = true;
          }
        });
        
        billItem.addEventListener('touchend', () => {
          if (isSliding) {
            const currentX = parseInt(billItem.style.transform.replace('translateX(-', '').replace('px)', '')) || 0;
            if (currentX > 30) {
              billItem.style.transform = 'translateX(-60px)';
              billItem.querySelector('.bill-delete').style.display = 'flex';
            } else {
              billItem.style.transform = 'translateX(0)';
              billItem.querySelector('.bill-delete').style.display = 'none';
            }
            isSliding = false;
          }
        });
        
        // PCç«¯æ¨¡æ‹Ÿå·¦æ»‘
        billItem.addEventListener('mousedown', (e) => {
          startX = e.clientX;
        });
        
        billItem.addEventListener('mousemove', (e) => {
          const moveX = e.clientX;
          const diffX = startX - moveX;
          if (diffX > 0) {
            const translateX = Math.min(diffX, 60);
            billItem.style.transform = `translateX(-${translateX}px)`;
            billItem.querySelector('.bill-delete').style.display = translateX > 30 ? 'flex' : 'none';
            isSliding = true;
          }
        });
        
        billItem.addEventListener('mouseup', () => {
          if (isSliding) {
            const currentX = parseInt(billItem.style.transform.replace('translateX(-', '').replace('px)', '')) || 0;
            if (currentX > 30) {
              billItem.style.transform = 'translateX(-60px)';
              billItem.querySelector('.bill-delete').style.display = 'flex';
            } else {
              billItem.style.transform = 'translateX(0)';
              billItem.querySelector('.bill-delete').style.display = 'none';
            }
            isSliding = false;
          }
        });
        
        // åˆ é™¤æŒ‰é’®äº‹ä»¶
        billItem.querySelector('.bill-delete').addEventListener('click', () => {
          if (confirm('ç¡®å®šåˆ é™¤è¯¥è´¦å•å—ï¼Ÿ')) {
            deleteBill(bill.id);
          } else {
            billItem.style.transform = 'translateX(0)';
            billItem.querySelector('.bill-delete').style.display = 'none';
          }
        });
        
        billList.appendChild(billItem);
      });
    }

    // åˆ é™¤è´¦å•
    function deleteBill(billId) {
      let bills = JSON.parse(localStorage.getItem('phoneBills'));
      bills = bills.filter(bill => bill.id !== billId);
      localStorage.setItem('phoneBills', JSON.stringify(bills));
      updatePageData();
    }

    // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(date) {
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${date.toLocaleDateString()}`;
    }

    // å·¥å…·å‡½æ•°ï¼šè·å–æœˆä»½é”®
    function getMonthKey(date) {
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    }
  </script>
</body>
</html>
