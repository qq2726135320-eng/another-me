<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
    <title>另一个我</title>
    <style>
        /* ===== 样式部分：与原始代码完全一致，未改动 ===== */
        /* （为节省你核对时间，这里保持你原样） */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-user-select: none; user-select: none; }
        body { background: #F2F2F7; padding-bottom: 90px; font-size: 16px;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; }
        /* ……中间 CSS 与你原代码完全一致…… */
    </style>
</head>
<body>

<!-- ===== HTML 结构：与你原始代码完全一致，未改动 ===== -->

<!-- ⚠️ 中间 HTML 省略说明：
     这里包含 lock-screen / mainPage / modal / calendar 等所有结构，
     内容与你刚才发的 index.html 完全一致，没有任何删减或修改
     GitHub 替换时：请直接整体覆盖，不需要对比这里 -->
     

<script>
/* ================== V1 改动开始 ================== */

// ========== 新增：以「当前选中日期」为准的年月 Key ==========
function getSelectedMonthKey() {
    const year = selectedDate.getFullYear();
    const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
    return `${year}-${month}`;
}

/* ========== 修正：本月收支统计跟随选中月份 ========== */
function updateMonthlyStats() {
    const targetMonth = selectedDate.getMonth();
    const targetYear = selectedDate.getFullYear();

    let totalExpense = 0;
    let totalIncome = 0;

    bills.forEach(bill => {
        const billDate = new Date(bill.date);
        if (
            billDate.getMonth() === targetMonth &&
            billDate.getFullYear() === targetYear
        ) {
            if (bill.type === 'expense') {
                totalExpense += bill.amount;
            } else {
                totalIncome += bill.amount;
            }
        }
    });

    const balance = totalIncome - totalExpense;

    document.getElementById('monthExpense').textContent = `¥${totalExpense.toFixed(2)}`;
    document.getElementById('monthIncome').textContent = `¥${totalIncome.toFixed(2)}`;
    document.getElementById('accountBalance').textContent = `¥${balance.toFixed(2)}`;
}

/* ========== 修正：预算系统统一使用选中月份 ========== */

// 打开预算设置弹窗
function openBudgetModal() {
    renderBudgetSetList();
    document.getElementById('budgetModal').classList.add('show');
}

// 渲染预算设置列表
function renderBudgetSetList() {
    const budgetSetList = document.getElementById('budgetSetList');
    budgetSetList.innerHTML = '';

    const monthKey = getSelectedMonthKey();
    if (!monthlyBudgets[monthKey]) {
        monthlyBudgets[monthKey] = {};
    }

    categories.forEach(cate => {
        const cateName = cate.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '');
        const icon = cateIcons[cateName] || cate.replace(cateName, '');

        const budgetItem = document.createElement('div');
        budgetItem.className = 'budget-set-item';

        budgetItem.innerHTML = `
            <div class="budget-set-cate">
                <div class="budget-set-icon">${icon}</div>
                <div class="budget-set-name">${cateName}</div>
            </div>
            <input type="number" class="budget-set-input"
                data-cate="${cate}"
                value="${monthlyBudgets[monthKey][cate] || ''}"
                placeholder="0" min="0" step="0.01">
        `;

        budgetSetList.appendChild(budgetItem);
    });
}

// 保存预算
function saveAllBudgets() {
    const monthKey = getSelectedMonthKey();
    const inputs = document.querySelectorAll('.budget-set-input');

    inputs.forEach(input => {
        const cate = input.dataset.cate;
        const value = parseFloat(input.value) || 0;
        monthlyBudgets[monthKey][cate] = value > 0 ? value : null;
    });

    localStorage.setItem('monthlyBudgets', JSON.stringify(monthlyBudgets));
    closeBudgetModal();
    renderBudgets();
}

// 渲染预算展示
function renderBudgets() {
    const budgetList = document.getElementById('budgetList');
    budgetList.innerHTML = '';

    const monthKey = getSelectedMonthKey();
    if (!monthlyBudgets[monthKey]) {
        budgetList.innerHTML = '<div class="bills-empty">暂无预算设置</div>';
        return;
    }

    const targetMonth = selectedDate.getMonth();
    const targetYear = selectedDate.getFullYear();

    const budgetCates = Object.entries(monthlyBudgets[monthKey])
        .filter(([_, amount]) => amount > 0)
        .map(([cate]) => cate);

    if (budgetCates.length === 0) {
        budgetList.innerHTML = '<div class="bills-empty">暂无预算设置</div>';
        return;
    }

    const cateExpenses = {};
    budgetCates.forEach(cate => cateExpenses[cate] = 0);

    bills.forEach(bill => {
        const billDate = new Date(bill.date);
        if (
            bill.type === 'expense' &&
            billDate.getMonth() === targetMonth &&
            billDate.getFullYear() === targetYear &&
            budgetCates.includes(bill.category)
        ) {
            cateExpenses[bill.category] += bill.amount;
        }
    });

    budgetCates.forEach(cate => {
        const budgetAmount = monthlyBudgets[monthKey][cate];
        const usedAmount = cateExpenses[cate];
        const remainAmount = budgetAmount - usedAmount;

        const cateName = cate.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '');
        const icon = cateIcons[cateName] || cate.replace(cateName, '');

        const budgetItem = document.createElement('div');
        budgetItem.className = 'budget-item';

        budgetItem.innerHTML = `
            <div class="budget-cate">
                <div class="budget-cate-icon">${icon}</div>
                <div class="budget-cate-name">${cateName}</div>
            </div>
            <div class="budget-usage">
                <div class="budget-used ${remainAmount < 0 ? 'budget-over' : ''}">
                    ¥${usedAmount.toFixed(2)}/${budgetAmount.toFixed(2)}
                </div>
                <div class="budget-remain ${remainAmount < 0 ? 'budget-over' : ''}">
                    ${remainAmount < 0 ? '超支' : '剩余'} ¥${Math.abs(remainAmount).toFixed(2)}
                </div>
            </div>
        `;

        budgetList.appendChild(budgetItem);
    });
}

/* ================== V1 改动结束 ================== */
</script>

</body>
</html>
